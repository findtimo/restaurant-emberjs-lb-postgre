{"version":3,"file":"hooks-dXmQbIOF.js","sources":["../src/-private/model-for-mixin.ts","../src/-private/schema-provider.ts","../src/-private/hooks.ts"],"sourcesContent":["import { getOwner } from '@ember/application';\n\nimport type Store from '@ember-data/store';\n\nimport Model, { type ModelFactory } from './model';\n\n/*\n    In case someone defined a relationship to a mixin, for example:\n    ```ts\n      class CommentModel extends Model {\n        @belongsTo('commentable', { polymorphic: true }) owner;\n      }\n\n      let Commentable = Mixin.create({\n        @hasMany('comment') comments;\n      });\n    ```\n    we want to look up a Commentable class which has all the necessary\n    relationship meta data. Thus, we look up the mixin and create a mock\n    Model, so we can access the relationship CPs of the mixin (`comments`)\n    in this case\n  */\nexport default function modelForMixin(store: Store, normalizedModelName: string): ModelFactory | undefined {\n  const owner = getOwner(store)!;\n  const MaybeMixin = owner.factoryFor(`mixin:${normalizedModelName}`);\n  const mixin = MaybeMixin && MaybeMixin.class;\n  if (mixin) {\n    const ModelForMixin = Model.extend(mixin);\n    ModelForMixin.__isMixin = true;\n    ModelForMixin.__mixin = mixin;\n    //Cache the class as a model\n    owner.register(`model:${normalizedModelName}`, ModelForMixin);\n  }\n  return owner.factoryFor(`model:${normalizedModelName}`) as ModelFactory | undefined;\n}\n","import { getOwner } from '@ember/application';\n\nimport type Store from '@ember-data/store';\nimport type { FieldSchema } from '@ember-data/store/-types/q/schema-service';\nimport type { RecordIdentifier } from '@warp-drive/core-types/identifier';\nimport type { AttributesSchema, RelationshipsSchema } from '@warp-drive/core-types/schema';\n\nimport type { FactoryCache, ModelFactory, ModelStore } from './model';\nimport type Model from './model';\nimport _modelForMixin from './model-for-mixin';\nimport { normalizeModelName } from './util';\n\nexport class ModelSchemaProvider {\n  declare store: ModelStore;\n  declare _relationshipsDefCache: Record<string, RelationshipsSchema>;\n  declare _attributesDefCache: Record<string, AttributesSchema>;\n  declare _fieldsDefCache: Record<string, Map<string, FieldSchema>>;\n\n  constructor(store: ModelStore) {\n    this.store = store;\n    this._relationshipsDefCache = Object.create(null) as Record<string, RelationshipsSchema>;\n    this._attributesDefCache = Object.create(null) as Record<string, AttributesSchema>;\n    this._fieldsDefCache = Object.create(null) as Record<string, Map<string, FieldSchema>>;\n  }\n\n  fields(identifier: RecordIdentifier | { type: string }): Map<string, FieldSchema> {\n    const { type } = identifier;\n    let fieldDefs: Map<string, FieldSchema> | undefined = this._fieldsDefCache[type];\n\n    if (fieldDefs === undefined) {\n      fieldDefs = new Map();\n      this._fieldsDefCache[type] = fieldDefs;\n\n      const attributes = this.attributesDefinitionFor(identifier);\n      const relationships = this.relationshipsDefinitionFor(identifier);\n\n      for (const attr of Object.values(attributes)) {\n        fieldDefs.set(attr.name, attr);\n      }\n\n      for (const rel of Object.values(relationships)) {\n        fieldDefs.set(rel.name, rel);\n      }\n    }\n\n    return fieldDefs;\n  }\n\n  // Following the existing RD implementation\n  attributesDefinitionFor(identifier: RecordIdentifier | { type: string }): AttributesSchema {\n    const { type } = identifier;\n    let attributes: AttributesSchema;\n\n    attributes = this._attributesDefCache[type];\n\n    if (attributes === undefined) {\n      const modelClass = this.store.modelFor(type);\n      const attributeMap = modelClass.attributes;\n\n      attributes = Object.create(null) as AttributesSchema;\n      attributeMap.forEach((meta, name) => (attributes[name] = meta));\n      this._attributesDefCache[type] = attributes;\n    }\n\n    return attributes;\n  }\n\n  // Following the existing RD implementation\n  relationshipsDefinitionFor(identifier: RecordIdentifier | { type: string }): RelationshipsSchema {\n    const { type } = identifier;\n    let relationships: RelationshipsSchema;\n\n    relationships = this._relationshipsDefCache[type];\n\n    if (relationships === undefined) {\n      const modelClass = this.store.modelFor(type) as typeof Model;\n      relationships = modelClass.relationshipsObject || null;\n      this._relationshipsDefCache[type] = relationships;\n    }\n\n    return relationships;\n  }\n\n  doesTypeExist(modelName: string): boolean {\n    const type = normalizeModelName(modelName);\n    const factory = getModelFactory(this.store, type);\n\n    return factory !== null;\n  }\n}\n\nexport function buildSchema(store: Store) {\n  return new ModelSchemaProvider(store as ModelStore);\n}\n\nexport function getModelFactory(store: ModelStore, type: string): ModelFactory | null {\n  if (!store._modelFactoryCache) {\n    store._modelFactoryCache = Object.create(null) as FactoryCache;\n  }\n  const cache = store._modelFactoryCache;\n  let factory: ModelFactory | undefined = cache[type];\n\n  if (!factory) {\n    const owner = getOwner(store)!;\n    factory = owner.factoryFor(`model:${type}`) as ModelFactory | undefined;\n\n    if (!factory) {\n      //Support looking up mixins as base types for polymorphic relationships\n      factory = _modelForMixin(store, type);\n    }\n\n    if (!factory) {\n      // we don't cache misses in case someone wants to register a missing model\n      return null;\n    }\n\n    const klass = factory.class;\n\n    if (klass.isModel) {\n      const hasOwnModelNameSet = klass.modelName && Object.prototype.hasOwnProperty.call(klass, 'modelName');\n      if (!hasOwnModelNameSet) {\n        Object.defineProperty(klass, 'modelName', { value: type });\n      }\n    }\n\n    cache[type] = factory;\n  }\n\n  return factory;\n}\n","import { getOwner, setOwner } from '@ember/application';\nimport { assert } from '@ember/debug';\n\nimport { setCacheFor, setRecordIdentifier, type Store, StoreMap } from '@ember-data/store/-private';\nimport type { StableRecordIdentifier } from '@warp-drive/core-types';\nimport type { Cache } from '@warp-drive/core-types/cache';\n\nimport type { ModelStore } from './model';\nimport type Model from './model';\nimport { getModelFactory } from './schema-provider';\nimport { normalizeModelName } from './util';\n\nfunction recast(context: Store): asserts context is ModelStore {}\n\nexport function instantiateRecord(\n  this: Store,\n  identifier: StableRecordIdentifier,\n  createRecordArgs: { [key: string]: unknown }\n): Model {\n  const type = identifier.type;\n\n  recast(this);\n\n  const cache = this.cache;\n  // TODO deprecate allowing unknown args setting\n  const createOptions = {\n    _createProps: createRecordArgs,\n    // TODO @deprecate consider deprecating accessing record properties during init which the below is necessary for\n    _secretInit: {\n      identifier,\n      cache,\n      store: this,\n      cb: secretInit,\n    },\n  };\n\n  // ensure that `getOwner(this)` works inside a model instance\n  setOwner(createOptions, getOwner(this)!);\n  const factory = getModelFactory(this, type);\n\n  assert(`No model was found for '${type}'`, factory);\n  return factory.class.create(createOptions);\n}\n\nexport function teardownRecord(record: Model): void {\n  assert(\n    `expected to receive an instance of Model from @ember-data/model. If using a custom model make sure you implement teardownRecord`,\n    'destroy' in record\n  );\n  record.destroy();\n}\n\nexport function modelFor(this: Store, modelName: string): typeof Model | void {\n  assert(\n    `Attempted to call store.modelFor(), but the store instance has already been destroyed.`,\n    !this.isDestroyed && !this.isDestroying\n  );\n  assert(`You need to pass a model name to the store's modelFor method`, modelName);\n  assert(\n    `Please pass a proper model name to the store's modelFor method`,\n    typeof modelName === 'string' && modelName.length\n  );\n  recast(this);\n\n  const type = normalizeModelName(modelName);\n  const maybeFactory = getModelFactory(this, type);\n  const klass = maybeFactory && maybeFactory.class ? maybeFactory.class : null;\n\n  const ignoreType = !klass || !klass.isModel || this._forceShim;\n  if (!ignoreType) {\n    return klass;\n  }\n  assert(\n    `No model was found for '${type}' and no schema handles the type`,\n    this.getSchemaDefinitionService().doesTypeExist(type)\n  );\n}\n\nfunction secretInit(record: Model, cache: Cache, identifier: StableRecordIdentifier, store: Store): void {\n  setRecordIdentifier(record, identifier);\n  StoreMap.set(record, store);\n  setCacheFor(record, cache);\n}\n"],"names":["modelForMixin","store","normalizedModelName","owner","getOwner","MaybeMixin","factoryFor","mixin","class","ModelForMixin","Model","extend","__isMixin","__mixin","register","ModelSchemaProvider","constructor","_relationshipsDefCache","Object","create","_attributesDefCache","_fieldsDefCache","fields","identifier","type","fieldDefs","undefined","Map","attributes","attributesDefinitionFor","relationships","relationshipsDefinitionFor","attr","values","set","name","rel","modelClass","modelFor","attributeMap","forEach","meta","relationshipsObject","doesTypeExist","modelName","normalizeModelName","factory","getModelFactory","buildSchema","_modelFactoryCache","cache","_modelForMixin","klass","isModel","hasOwnModelNameSet","prototype","hasOwnProperty","call","defineProperty","value","instantiateRecord","createRecordArgs","createOptions","_createProps","_secretInit","cb","secretInit","setOwner","assert","teardownRecord","record","destroy","isDestroyed","isDestroying","length","maybeFactory","ignoreType","_forceShim","getSchemaDefinitionService","setRecordIdentifier","StoreMap","setCacheFor"],"mappings":"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"}