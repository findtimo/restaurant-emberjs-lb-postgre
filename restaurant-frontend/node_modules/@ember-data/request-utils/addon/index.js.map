{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { assert, deprecate } from '@ember/debug';\n\nimport type { Cache } from '@warp-drive/core-types/cache';\nimport type { StableDocumentIdentifier } from '@warp-drive/core-types/identifier';\nimport type { QueryParamsSerializationOptions, QueryParamsSource, Serializable } from '@warp-drive/core-types/params';\nimport type { ImmutableRequestInfo, ResponseInfo } from '@warp-drive/core-types/request';\n\ntype Store = {\n  cache: Cache;\n};\n\n/**\n * Simple utility function to assist in url building,\n * query params, and other common request operations.\n *\n * These primitives may be used directly or composed\n * by request builders to provide a consistent interface\n * for building requests.\n *\n * For instance:\n *\n * ```ts\n * import { buildBaseURL, buildQueryParams } from '@ember-data/request-utils';\n *\n * const baseURL = buildBaseURL({\n *   host: 'https://api.example.com',\n *   namespace: 'api/v1',\n *   resourcePath: 'emberDevelopers',\n *   op: 'query',\n *   identifier: { type: 'ember-developer' }\n * });\n * const url = `${baseURL}?${buildQueryParams({ name: 'Chris', include:['pets'] })}`;\n * // => 'https://api.example.com/api/v1/emberDevelopers?include=pets&name=Chris'\n * ```\n *\n * This is useful, but not as useful as the REST request builder for query which is sugar\n * over this (and more!):\n *\n * ```ts\n * import { query } from '@ember-data/rest/request';\n *\n * const options = query('ember-developer', { name: 'Chris', include:['pets'] });\n * // => { url: 'https://api.example.com/api/v1/emberDevelopers?include=pets&name=Chris' }\n * // Note: options will also include other request options like headers, method, etc.\n * ```\n *\n * @module @ember-data/request-utils\n * @main @ember-data/request-utils\n * @public\n */\n\n// prevents the final constructed object from needing to add\n// host and namespace which are provided by the final consuming\n// class to the prototype which can result in overwrite errors\n\nexport interface BuildURLConfig {\n  host: string | null;\n  namespace: string | null;\n}\n\nconst CONFIG: BuildURLConfig = {\n  host: '',\n  namespace: '',\n};\n\n/**\n * Sets the global configuration for `buildBaseURL`\n * for host and namespace values for the application.\n *\n * These values may still be overridden by passing\n * them to buildBaseURL directly.\n *\n * This method may be called as many times as needed.\n * host values of `''` or `'/'` are equivalent.\n *\n * Except for the value of `/` as host, host should not\n * end with `/`.\n *\n * namespace should not start or end with a `/`.\n *\n * ```ts\n * type BuildURLConfig = {\n *   host: string;\n *   namespace: string'\n * }\n * ```\n *\n * Example:\n *\n * ```ts\n * import { setBuildURLConfig } from '@ember-data/request-utils';\n *\n * setBuildURLConfig({\n *   host: 'https://api.example.com',\n *   namespace: 'api/v1'\n * });\n * ```\n *\n * @method setBuildURLConfig\n * @static\n * @public\n * @for @ember-data/request-utils\n * @param {BuildURLConfig} config\n * @return void\n */\nexport function setBuildURLConfig(config: BuildURLConfig) {\n  assert(`setBuildURLConfig: You must pass a config object`, config);\n  assert(\n    `setBuildURLConfig: You must pass a config object with a 'host' or 'namespace' property`,\n    'host' in config || 'namespace' in config\n  );\n\n  CONFIG.host = config.host || '';\n  CONFIG.namespace = config.namespace || '';\n\n  assert(\n    `buildBaseURL: host must NOT end with '/', received '${CONFIG.host}'`,\n    CONFIG.host === '/' || !CONFIG.host.endsWith('/')\n  );\n  assert(\n    `buildBaseURL: namespace must NOT start with '/', received '${CONFIG.namespace}'`,\n    !CONFIG.namespace.startsWith('/')\n  );\n  assert(\n    `buildBaseURL: namespace must NOT end with '/', received '${CONFIG.namespace}'`,\n    !CONFIG.namespace.endsWith('/')\n  );\n}\n\nexport interface FindRecordUrlOptions {\n  op: 'findRecord';\n  identifier: { type: string; id: string };\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface QueryUrlOptions {\n  op: 'query';\n  identifier: { type: string };\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface FindManyUrlOptions {\n  op: 'findMany';\n  identifiers: { type: string; id: string }[];\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\nexport interface FindRelatedCollectionUrlOptions {\n  op: 'findRelatedCollection';\n  identifier: { type: string; id: string };\n  fieldPath: string;\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface FindRelatedResourceUrlOptions {\n  op: 'findRelatedRecord';\n  identifier: { type: string; id: string };\n  fieldPath: string;\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface CreateRecordUrlOptions {\n  op: 'createRecord';\n  identifier: { type: string };\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface UpdateRecordUrlOptions {\n  op: 'updateRecord';\n  identifier: { type: string; id: string };\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface DeleteRecordUrlOptions {\n  op: 'deleteRecord';\n  identifier: { type: string; id: string };\n  resourcePath?: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport interface GenericUrlOptions {\n  resourcePath: string;\n  host?: string;\n  namespace?: string;\n}\n\nexport type UrlOptions =\n  | FindRecordUrlOptions\n  | QueryUrlOptions\n  | FindManyUrlOptions\n  | FindRelatedCollectionUrlOptions\n  | FindRelatedResourceUrlOptions\n  | CreateRecordUrlOptions\n  | UpdateRecordUrlOptions\n  | DeleteRecordUrlOptions\n  | GenericUrlOptions;\n\nconst OPERATIONS_WITH_PRIMARY_RECORDS = new Set([\n  'findRecord',\n  'findRelatedRecord',\n  'findRelatedCollection',\n  'updateRecord',\n  'deleteRecord',\n]);\n\nfunction isOperationWithPrimaryRecord(\n  options: UrlOptions\n): options is\n  | FindRecordUrlOptions\n  | FindRelatedCollectionUrlOptions\n  | FindRelatedResourceUrlOptions\n  | UpdateRecordUrlOptions\n  | DeleteRecordUrlOptions {\n  return 'op' in options && OPERATIONS_WITH_PRIMARY_RECORDS.has(options.op);\n}\n\nfunction hasResourcePath(options: UrlOptions): options is GenericUrlOptions {\n  return 'resourcePath' in options && typeof options.resourcePath === 'string' && options.resourcePath.length > 0;\n}\n\nfunction resourcePathForType(options: UrlOptions): string {\n  assert(\n    `resourcePathForType: You must pass a valid op as part of options`,\n    'op' in options && typeof options.op === 'string'\n  );\n  return options.op === 'findMany' ? options.identifiers[0].type : options.identifier.type;\n}\n\n/**\n * Builds a URL for a request based on the provided options.\n * Does not include support for building query params (see `buildQueryParams`)\n * so that it may be composed cleanly with other query-params strategies.\n *\n * Usage:\n *\n * ```ts\n * import { buildBaseURL } from '@ember-data/request-utils';\n *\n * const url = buildBaseURL({\n *   host: 'https://api.example.com',\n *   namespace: 'api/v1',\n *   resourcePath: 'emberDevelopers',\n *   op: 'query',\n *   identifier: { type: 'ember-developer' }\n * });\n *\n * // => 'https://api.example.com/api/v1/emberDevelopers'\n * ```\n *\n * On the surface this may seem like a lot of work to do something simple, but\n * it is designed to be composable with other utilities and interfaces that the\n * average product engineer will never need to see or use.\n *\n * A few notes:\n *\n * - `resourcePath` is optional, but if it is not provided, `identifier.type` will be used.\n * - `host` and `namespace` are optional, but if they are not provided, the values globally\n *    configured via `setBuildURLConfig` will be used.\n * - `op` is required and must be one of the following:\n *   - 'findRecord' 'query' 'findMany' 'findRelatedCollection' 'findRelatedRecord'` 'createRecord' 'updateRecord' 'deleteRecord'\n * - Depending on the value of `op`, `identifier` or `identifiers` will be required.\n *\n * @method buildBaseURL\n * @static\n * @public\n * @for @ember-data/request-utils\n * @param urlOptions\n * @return string\n */\nexport function buildBaseURL(urlOptions: UrlOptions): string {\n  const options = Object.assign(\n    {\n      host: CONFIG.host,\n      namespace: CONFIG.namespace,\n    },\n    urlOptions\n  );\n  assert(\n    `buildBaseURL: You must pass \\`op\\` as part of options`,\n    hasResourcePath(options) || (typeof options.op === 'string' && options.op.length > 0)\n  );\n  assert(\n    `buildBaseURL: You must pass \\`identifier\\` as part of options`,\n    hasResourcePath(options) ||\n      options.op === 'findMany' ||\n      (options.identifier && typeof options.identifier === 'object')\n  );\n  assert(\n    `buildBaseURL: You must pass \\`identifiers\\` as part of options`,\n    hasResourcePath(options) ||\n      options.op !== 'findMany' ||\n      (options.identifiers &&\n        Array.isArray(options.identifiers) &&\n        options.identifiers.length > 0 &&\n        options.identifiers.every((i) => i && typeof i === 'object'))\n  );\n  assert(\n    `buildBaseURL: You must pass valid \\`identifier\\` as part of options, expected 'id'`,\n    hasResourcePath(options) ||\n      !isOperationWithPrimaryRecord(options) ||\n      (typeof options.identifier.id === 'string' && options.identifier.id.length > 0)\n  );\n  assert(\n    `buildBaseURL: You must pass \\`identifiers\\` as part of options`,\n    hasResourcePath(options) ||\n      options.op !== 'findMany' ||\n      options.identifiers.every((i) => typeof i.id === 'string' && i.id.length > 0)\n  );\n  assert(\n    `buildBaseURL: You must pass valid \\`identifier\\` as part of options, expected 'type'`,\n    hasResourcePath(options) ||\n      options.op === 'findMany' ||\n      (typeof options.identifier.type === 'string' && options.identifier.type.length > 0)\n  );\n  assert(\n    `buildBaseURL: You must pass valid \\`identifiers\\` as part of options, expected 'type'`,\n    hasResourcePath(options) ||\n      options.op !== 'findMany' ||\n      (typeof options.identifiers[0].type === 'string' && options.identifiers[0].type.length > 0)\n  );\n\n  // prettier-ignore\n  const idPath: string =\n      isOperationWithPrimaryRecord(options) ? encodeURIComponent(options.identifier.id)\n      : '';\n  const resourcePath = options.resourcePath || resourcePathForType(options);\n  const { host, namespace } = options;\n  const fieldPath = 'fieldPath' in options ? options.fieldPath : '';\n\n  assert(\n    `buildBaseURL: You tried to build a url for a ${String(\n      'op' in options ? options.op + ' ' : ''\n    )}request to ${resourcePath} but resourcePath must be set or op must be one of \"${[\n      'findRecord',\n      'findRelatedRecord',\n      'findRelatedCollection',\n      'updateRecord',\n      'deleteRecord',\n      'createRecord',\n      'query',\n      'findMany',\n    ].join('\",\"')}\".`,\n    hasResourcePath(options) ||\n      [\n        'findRecord',\n        'query',\n        'findMany',\n        'findRelatedCollection',\n        'findRelatedRecord',\n        'createRecord',\n        'updateRecord',\n        'deleteRecord',\n      ].includes(options.op)\n  );\n\n  assert(`buildBaseURL: host must NOT end with '/', received '${host}'`, host === '/' || !host.endsWith('/'));\n  assert(`buildBaseURL: namespace must NOT start with '/', received '${namespace}'`, !namespace.startsWith('/'));\n  assert(`buildBaseURL: namespace must NOT end with '/', received '${namespace}'`, !namespace.endsWith('/'));\n  assert(\n    `buildBaseURL: resourcePath must NOT start with '/', received '${resourcePath}'`,\n    !resourcePath.startsWith('/')\n  );\n  assert(`buildBaseURL: resourcePath must NOT end with '/', received '${resourcePath}'`, !resourcePath.endsWith('/'));\n  assert(`buildBaseURL: fieldPath must NOT start with '/', received '${fieldPath}'`, !fieldPath.startsWith('/'));\n  assert(`buildBaseURL: fieldPath must NOT end with '/', received '${fieldPath}'`, !fieldPath.endsWith('/'));\n  assert(`buildBaseURL: idPath must NOT start with '/', received '${idPath}'`, !idPath.startsWith('/'));\n  assert(`buildBaseURL: idPath must NOT end with '/', received '${idPath}'`, !idPath.endsWith('/'));\n\n  const hasHost = host !== '' && host !== '/';\n  const url = [hasHost ? host : '', namespace, resourcePath, idPath, fieldPath].filter(Boolean).join('/');\n  return hasHost ? url : `/${url}`;\n}\n\nconst DEFAULT_QUERY_PARAMS_SERIALIZATION_OPTIONS: QueryParamsSerializationOptions = {\n  arrayFormat: 'comma',\n};\n\nfunction handleInclude(include: string | string[]): string[] {\n  assert(\n    `Expected include to be a string or array, got ${typeof include}`,\n    typeof include === 'string' || Array.isArray(include)\n  );\n  return typeof include === 'string' ? include.split(',') : include;\n}\n\n/**\n * filter out keys of an object that have falsy values or point to empty arrays\n * returning a new object with only those keys that have truthy values / non-empty arrays\n *\n * @method filterEmpty\n * @static\n * @public\n * @for @ember-data/request-utils\n * @param {Record<string, Serializable>} source object to filter keys with empty values from\n * @return {Record<string, Serializable>} A new object with the keys that contained empty values removed\n */\nexport function filterEmpty(source: Record<string, Serializable>): Record<string, Serializable> {\n  const result: Record<string, Serializable> = {};\n  for (const key in source) {\n    const value = source[key];\n    // Allow `0` and `false` but filter falsy values that indicate \"empty\"\n    if (value !== undefined && value !== null && value !== '') {\n      if (!Array.isArray(value) || value.length > 0) {\n        result[key] = source[key];\n      }\n    }\n  }\n  return result;\n}\n\n/**\n * Sorts query params by both key and value returning a new URLSearchParams\n * object with the keys inserted in sorted order.\n *\n * Treats `included` specially, splicing it into an array if it is a string and sorting the array.\n *\n * Options:\n * - arrayFormat: 'bracket' | 'indices' | 'repeat' | 'comma'\n *\n * 'bracket': appends [] to the key for every value e.g. `&ids[]=1&ids[]=2`\n * 'indices': appends [i] to the key for every value e.g. `&ids[0]=1&ids[1]=2`\n * 'repeat': appends the key for every value e.g. `&ids=1&ids=2`\n * 'comma' (default): appends the key once with a comma separated list of values e.g. `&ids=1,2`\n *\n * @method sortQueryParams\n * @static\n * @public\n * @for @ember-data/request-utils\n * @param {URLSearchParams | object} params\n * @param {object} options\n * @return {URLSearchParams} A URLSearchParams with keys inserted in sorted order\n */\nexport function sortQueryParams(params: QueryParamsSource, options?: QueryParamsSerializationOptions): URLSearchParams {\n  const opts = Object.assign({}, DEFAULT_QUERY_PARAMS_SERIALIZATION_OPTIONS, options);\n  const paramsIsObject = !(params instanceof URLSearchParams);\n  const urlParams = new URLSearchParams();\n  const dictionaryParams: Record<string, Serializable> = paramsIsObject ? params : {};\n\n  if (!paramsIsObject) {\n    params.forEach((value, key) => {\n      const hasExisting = key in dictionaryParams;\n      if (!hasExisting) {\n        dictionaryParams[key] = value;\n      } else {\n        const existingValue = dictionaryParams[key];\n        if (Array.isArray(existingValue)) {\n          existingValue.push(value);\n        } else {\n          dictionaryParams[key] = [existingValue, value];\n        }\n      }\n    });\n  }\n\n  if ('include' in dictionaryParams) {\n    dictionaryParams.include = handleInclude(dictionaryParams.include as string | string[]);\n  }\n\n  const sortedKeys = Object.keys(dictionaryParams).sort();\n  sortedKeys.forEach((key) => {\n    const value = dictionaryParams[key];\n    if (Array.isArray(value)) {\n      value.sort();\n      switch (opts.arrayFormat) {\n        case 'indices':\n          value.forEach((v, i) => {\n            urlParams.append(`${key}[${i}]`, String(v));\n          });\n          return;\n        case 'bracket':\n          value.forEach((v) => {\n            urlParams.append(`${key}[]`, String(v));\n          });\n          return;\n        case 'repeat':\n          value.forEach((v) => {\n            urlParams.append(key, String(v));\n          });\n          return;\n        case 'comma':\n        default:\n          urlParams.append(key, value.join(','));\n          return;\n      }\n    } else {\n      urlParams.append(key, String(value));\n    }\n  });\n\n  return urlParams;\n}\n\n/**\n * Sorts query params by both key and value, returning a query params string\n *\n * Treats `included` specially, splicing it into an array if it is a string and sorting the array.\n *\n * Options:\n * - arrayFormat: 'bracket' | 'indices' | 'repeat' | 'comma'\n *\n * 'bracket': appends [] to the key for every value e.g. `ids[]=1&ids[]=2`\n * 'indices': appends [i] to the key for every value e.g. `ids[0]=1&ids[1]=2`\n * 'repeat': appends the key for every value e.g. `ids=1&ids=2`\n * 'comma' (default): appends the key once with a comma separated list of values e.g. `ids=1,2`\n *\n * @method buildQueryParams\n * @static\n * @public\n * @for @ember-data/request-utils\n * @param {URLSearchParams | object} params\n * @param {object} [options]\n * @return {string} A sorted query params string without the leading `?`\n */\nexport function buildQueryParams(params: QueryParamsSource, options?: QueryParamsSerializationOptions): string {\n  return sortQueryParams(params, options).toString();\n}\nexport interface CacheControlValue {\n  immutable?: boolean;\n  'max-age'?: number;\n  'must-revalidate'?: boolean;\n  'must-understand'?: boolean;\n  'no-cache'?: boolean;\n  'no-store'?: boolean;\n  'no-transform'?: boolean;\n  'only-if-cached'?: boolean;\n  private?: boolean;\n  'proxy-revalidate'?: boolean;\n  public?: boolean;\n  's-maxage'?: number;\n  'stale-if-error'?: number;\n  'stale-while-revalidate'?: number;\n}\n\ntype CacheControlKey = keyof CacheControlValue;\n\nconst NUMERIC_KEYS = new Set(['max-age', 's-maxage', 'stale-if-error', 'stale-while-revalidate']);\n\n/**\n *  Parses a string Cache-Control header value into an object with the following structure:\n *\n * ```ts\n * interface CacheControlValue {\n *   immutable?: boolean;\n *   'max-age'?: number;\n *   'must-revalidate'?: boolean;\n *   'must-understand'?: boolean;\n *   'no-cache'?: boolean;\n *   'no-store'?: boolean;\n *   'no-transform'?: boolean;\n *   'only-if-cached'?: boolean;\n *   private?: boolean;\n *   'proxy-revalidate'?: boolean;\n *   public?: boolean;\n *   's-maxage'?: number;\n *   'stale-if-error'?: number;\n *   'stale-while-revalidate'?: number;\n * }\n * ```\n * @method parseCacheControl\n * @static\n * @public\n * @for @ember-data/request-utils\n * @param {string} header\n * @return {CacheControlValue}\n */\nexport function parseCacheControl(header: string): CacheControlValue {\n  let key: CacheControlKey = '' as CacheControlKey;\n  let value = '';\n  let isParsingKey = true;\n  const cacheControlValue: CacheControlValue = {};\n\n  function parseCacheControlValue(stringToParse: string): number {\n    const parsedValue = Number.parseInt(stringToParse);\n    assert(`Invalid Cache-Control value, expected a number but got - ${stringToParse}`, !Number.isNaN(parsedValue));\n    return parsedValue;\n  }\n\n  for (let i = 0; i < header.length; i++) {\n    const char = header.charAt(i);\n    if (char === ',') {\n      assert(`Invalid Cache-Control value, expected a value`, !isParsingKey || !NUMERIC_KEYS.has(key));\n      assert(\n        `Invalid Cache-Control value, expected a value after \"=\" but got \",\"`,\n        i === 0 || header.charAt(i - 1) !== '='\n      );\n      isParsingKey = true;\n      // @ts-expect-error TS incorrectly thinks that optional keys must have a type that includes undefined\n      cacheControlValue[key] = NUMERIC_KEYS.has(key) ? parseCacheControlValue(value) : true;\n      key = '' as CacheControlKey;\n      value = '';\n      continue;\n    } else if (char === '=') {\n      assert(`Invalid Cache-Control value, expected a value after \"=\"`, i + 1 !== header.length);\n      isParsingKey = false;\n    } else if (char === ' ' || char === `\\t` || char === `\\n`) {\n      continue;\n    } else if (isParsingKey) {\n      key += char;\n    } else {\n      value += char;\n    }\n\n    if (i === header.length - 1) {\n      // @ts-expect-error TS incorrectly thinks that optional keys must have a type that includes undefined\n      cacheControlValue[key] = NUMERIC_KEYS.has(key) ? parseCacheControlValue(value) : true;\n    }\n  }\n\n  return cacheControlValue;\n}\n\nfunction isStale(headers: Headers, expirationTime: number): boolean {\n  // const age = headers.get('age');\n  // const cacheControl = parseCacheControl(headers.get('cache-control') || '');\n  // const expires = headers.get('expires');\n  // const lastModified = headers.get('last-modified');\n  const date = headers.get('date');\n\n  if (!date) {\n    return true;\n  }\n\n  const time = new Date(date).getTime();\n  const now = Date.now();\n  const deadline = time + expirationTime;\n\n  const result = now > deadline;\n\n  return result;\n}\n\nexport type LifetimesConfig = { apiCacheSoftExpires: number; apiCacheHardExpires: number };\n\n/**\n * A basic LifetimesService that can be added to the Store service.\n *\n * Determines staleness based on time since the request was last received from the API\n * using the `date` header.\n *\n * Invalidates any request for which `cacheOptions.types` was provided when a createRecord\n * request for that type is successful.\n *\n * This allows the Store's CacheHandler to determine if a request is expired and\n * should be refetched upon next request.\n *\n * The `Fetch` handler provided by `@ember-data/request/fetch` will automatically\n * add the `date` header to responses if it is not present.\n *\n * Note: Date headers do not have millisecond precision, so expiration times should\n * generally be larger than 1000ms.\n *\n * Usage:\n *\n * ```ts\n * import { LifetimesService } from '@ember-data/request-utils';\n * import DataStore from '@ember-data/store';\n *\n * // ...\n *\n * export class Store extends DataStore {\n *   constructor(args) {\n *     super(args);\n *     this.lifetimes = new LifetimesService({ apiCacheSoftExpires: 30_000, apiCacheHardExpires: 60_000 });\n *   }\n * }\n * ```\n *\n * @class LifetimesService\n * @public\n * @module @ember-data/request-utils\n */\nexport class LifetimesService {\n  declare config: LifetimesConfig;\n  declare _stores: WeakMap<Store, { invalidated: Set<string>; types: Map<string, Set<string>> }>;\n\n  _getStore(store: Store): { invalidated: Set<string>; types: Map<string, Set<string>> } {\n    let set = this._stores.get(store);\n    if (!set) {\n      set = { invalidated: new Set(), types: new Map() };\n      this._stores.set(store, set);\n    }\n    return set;\n  }\n\n  constructor(config: LifetimesConfig) {\n    this._stores = new WeakMap();\n\n    const _config = arguments.length === 1 ? config : (arguments[1] as unknown as LifetimesConfig);\n    deprecate(\n      `Passing a Store to the LifetimesService is deprecated, please pass only a config instead.`,\n      arguments.length === 1,\n      {\n        id: 'ember-data:request-utils:lifetimes-service-store-arg',\n        since: {\n          enabled: '5.4',\n          available: '5.4',\n        },\n        for: '@ember-data/request-utils',\n        until: '6.0',\n      }\n    );\n    assert(`You must pass a config to the LifetimesService`, _config);\n    assert(\n      `You must pass a apiCacheSoftExpires to the LifetimesService`,\n      typeof _config.apiCacheSoftExpires === 'number'\n    );\n    assert(\n      `You must pass a apiCacheHardExpires to the LifetimesService`,\n      typeof _config.apiCacheHardExpires === 'number'\n    );\n    this.config = _config;\n  }\n\n  /**\n   * Invalidate a request by its identifier for a given store instance.\n   *\n   * While the store argument may seem redundant, the lifetimes service\n   * is designed to be shared across multiple stores / forks\n   * of the store.\n   *\n   * ```ts\n   * store.lifetimes.invalidateRequest(store, identifier);\n   * ```\n   *\n   * @method invalidateRequest\n   * @public\n   * @param {StableDocumentIdentifier} identifier\n   * @param {Store} store\n   */\n  invalidateRequest(identifier: StableDocumentIdentifier, store: Store): void {\n    this._getStore(store).invalidated.add(identifier.lid);\n  }\n\n  /**\n   * Invalidate all requests associated to a specific type\n   * for a given store instance.\n   *\n   * While the store argument may seem redundant, the lifetimes service\n   * is designed to be shared across multiple stores / forks\n   * of the store.\n   *\n   * This invalidation is done automatically when using this service\n   * for both the CacheHandler and the LegacyNetworkHandler.\n   *\n   * ```ts\n   * store.lifetimes.invalidateRequestsForType(store, 'person');\n   * ```\n   *\n   * @method invalidateRequestsForType\n   * @public\n   * @param {string} type\n   * @param {Store} store\n   */\n  invalidateRequestsForType(type: string, store: Store): void {\n    const storeCache = this._getStore(store);\n    const set = storeCache.types.get(type);\n    if (set) {\n      set.forEach((id) => {\n        storeCache.invalidated.add(id);\n      });\n    }\n  }\n\n  /**\n   * Invoked when a request has been fulfilled from the configured request handlers.\n   * This is invoked by the CacheHandler for both foreground and background requests\n   * once the cache has been updated.\n   *\n   * Note, this is invoked by the CacheHandler regardless of whether\n   * the request has a cache-key.\n   *\n   * This method should not be invoked directly by consumers.\n   *\n   * @method didRequest\n   * @public\n   * @param {ImmutableRequestInfo} request\n   * @param {ImmutableResponse} response\n   * @param {Store} store\n   * @param {StableDocumentIdentifier | null} identifier\n   * @return {void}\n   */\n  didRequest(\n    request: ImmutableRequestInfo,\n    response: Response | ResponseInfo | null,\n    identifier: StableDocumentIdentifier | null,\n    store: Store\n  ): void {\n    // if this is a successful createRecord request, invalidate the cacheKey for the type\n    if (request.op === 'createRecord') {\n      const statusNumber = response?.status ?? 0;\n      if (statusNumber >= 200 && statusNumber < 400) {\n        const types = new Set(request.records?.map((r) => r.type));\n        types.forEach((type) => {\n          this.invalidateRequestsForType(type, store);\n        });\n      }\n\n      // add this document's cacheKey to a map for all associated types\n      // it is recommended to only use this for queries\n    } else if (identifier && request.cacheOptions?.types?.length) {\n      const storeCache = this._getStore(store);\n      request.cacheOptions?.types.forEach((type) => {\n        const set = storeCache.types.get(type);\n        if (set) {\n          set.add(identifier.lid);\n          storeCache.invalidated.delete(identifier.lid);\n        } else {\n          storeCache.types.set(type, new Set([identifier.lid]));\n        }\n      });\n    }\n  }\n\n  /**\n   * Invoked to determine if the request may be fulfilled from cache\n   * if possible.\n   *\n   * Note, this is only invoked by the CacheHandler if the request has\n   * a cache-key.\n   *\n   * If no cache entry is found or the entry is hard expired,\n   * the request will be fulfilled from the configured request handlers\n   * and the cache will be updated before returning the response.\n   *\n   * @method isHardExpired\n   * @public\n   * @param {StableDocumentIdentifier} identifier\n   * @param {Store} store\n   * @return {boolean} true if the request is considered hard expired\n   */\n  isHardExpired(identifier: StableDocumentIdentifier, store: Store): boolean {\n    // if we are explicitly invalidated, we are hard expired\n    const storeCache = this._getStore(store);\n    if (storeCache.invalidated.has(identifier.lid)) {\n      return true;\n    }\n    const cache = store.cache;\n    const cached = cache.peekRequest(identifier);\n    return !cached || !cached.response || isStale(cached.response.headers, this.config.apiCacheHardExpires);\n  }\n\n  /**\n   * Invoked if `isHardExpired` is false to determine if the request\n   * should be update behind the scenes if cache data is already available.\n   *\n   * Note, this is only invoked by the CacheHandler if the request has\n   * a cache-key.\n   *\n   * If true, the request will be fulfilled from cache while a backgrounded\n   * request is made to update the cache via the configured request handlers.\n   *\n   * @method isSoftExpired\n   * @public\n   * @param {StableDocumentIdentifier} identifier\n   * @param {Store} store\n   * @return {boolean} true if the request is considered soft expired\n   */\n  isSoftExpired(identifier: StableDocumentIdentifier, store: Store): boolean {\n    const cache = store.cache;\n    const cached = cache.peekRequest(identifier);\n    return !cached || !cached.response || isStale(cached.response.headers, this.config.apiCacheSoftExpires);\n  }\n}\n"],"names":["CONFIG","host","namespace","setBuildURLConfig","config","assert","endsWith","startsWith","OPERATIONS_WITH_PRIMARY_RECORDS","Set","isOperationWithPrimaryRecord","options","has","op","hasResourcePath","resourcePath","length","resourcePathForType","identifiers","type","identifier","buildBaseURL","urlOptions","Object","assign","Array","isArray","every","i","id","idPath","encodeURIComponent","fieldPath","String","join","includes","hasHost","url","filter","Boolean","DEFAULT_QUERY_PARAMS_SERIALIZATION_OPTIONS","arrayFormat","handleInclude","include","split","filterEmpty","source","result","key","value","undefined","sortQueryParams","params","opts","paramsIsObject","URLSearchParams","urlParams","dictionaryParams","forEach","hasExisting","existingValue","push","sortedKeys","keys","sort","v","append","buildQueryParams","toString","NUMERIC_KEYS","parseCacheControl","header","isParsingKey","cacheControlValue","parseCacheControlValue","stringToParse","parsedValue","Number","parseInt","isNaN","char","charAt","isStale","headers","expirationTime","date","get","time","Date","getTime","now","deadline","LifetimesService","_getStore","store","set","_stores","invalidated","types","Map","constructor","WeakMap","_config","arguments","deprecate","since","enabled","available","for","until","apiCacheSoftExpires","apiCacheHardExpires","invalidateRequest","add","lid","invalidateRequestsForType","storeCache","didRequest","request","response","statusNumber","status","records","map","r","cacheOptions","delete","isHardExpired","cache","cached","peekRequest","isSoftExpired"],"mappings":";;AAWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAOA,MAAMA,MAAsB,GAAG;AAC7BC,EAAAA,IAAI,EAAE,EAAE;AACRC,EAAAA,SAAS,EAAE,EAAA;AACb,CAAC,CAAA;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASC,iBAAiBA,CAACC,MAAsB,EAAE;AACxDC,EAAAA,MAAM,CAAE,CAAA,gDAAA,CAAiD,EAAED,MAAM,CAAC,CAAA;EAClEC,MAAM,CACH,CAAuF,sFAAA,CAAA,EACxF,MAAM,IAAID,MAAM,IAAI,WAAW,IAAIA,MACrC,CAAC,CAAA;AAEDJ,EAAAA,MAAM,CAACC,IAAI,GAAGG,MAAM,CAACH,IAAI,IAAI,EAAE,CAAA;AAC/BD,EAAAA,MAAM,CAACE,SAAS,GAAGE,MAAM,CAACF,SAAS,IAAI,EAAE,CAAA;EAEzCG,MAAM,CACH,uDAAsDL,MAAM,CAACC,IAAK,CAAE,CAAA,CAAA,EACrED,MAAM,CAACC,IAAI,KAAK,GAAG,IAAI,CAACD,MAAM,CAACC,IAAI,CAACK,QAAQ,CAAC,GAAG,CAClD,CAAC,CAAA;AACDD,EAAAA,MAAM,CACH,CAA6DL,2DAAAA,EAAAA,MAAM,CAACE,SAAU,GAAE,EACjF,CAACF,MAAM,CAACE,SAAS,CAACK,UAAU,CAAC,GAAG,CAClC,CAAC,CAAA;AACDF,EAAAA,MAAM,CACH,CAA2DL,yDAAAA,EAAAA,MAAM,CAACE,SAAU,GAAE,EAC/E,CAACF,MAAM,CAACE,SAAS,CAACI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"}