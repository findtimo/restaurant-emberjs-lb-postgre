<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../packages/store/src/-private/record-arrays/identifier-array.ts - EmberData Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EmberData Documentation" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 5.3.3+58cd284b</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/&lt;Interface&gt; Adapter.html">&lt;Interface&gt; Adapter</a></li>
                                <li><a href="../classes/&lt;Interface&gt; Cache.html">&lt;Interface&gt; Cache</a></li>
                                <li><a href="../classes/&lt;Interface&gt; Handler.html">&lt;Interface&gt; Handler</a></li>
                                <li><a href="../classes/&lt;Interface&gt; LifetimesService.html">&lt;Interface&gt; LifetimesService</a></li>
                                <li><a href="../classes/&lt;Interface&gt; Serializer.html">&lt;Interface&gt; Serializer</a></li>
                                <li><a href="../classes/@ember-data/active-record/request.html">@ember-data/active-record/request</a></li>
                                <li><a href="../classes/@ember-data/adapter/rest.html">@ember-data/adapter/rest</a></li>
                                <li><a href="../classes/@ember-data/json-api/request.html">@ember-data/json-api/request</a></li>
                                <li><a href="../classes/@ember-data/model.html">@ember-data/model</a></li>
                                <li><a href="../classes/@ember-data/request-utils.html">@ember-data/request-utils</a></li>
                                <li><a href="../classes/@ember-data/rest/request.html">@ember-data/rest/request</a></li>
                                <li><a href="../classes/@ember-data/store.html">@ember-data/store</a></li>
                                <li><a href="../classes/@ember-data/tracking.html">@ember-data/tracking</a></li>
                                <li><a href="../classes/AbortError.html">AbortError</a></li>
                                <li><a href="../classes/Adapter.html">Adapter</a></li>
                                <li><a href="../classes/AdapterError.html">AdapterError</a></li>
                                <li><a href="../classes/BelongsToReference.html">BelongsToReference</a></li>
                                <li><a href="../classes/BooleanTransform.html">BooleanTransform</a></li>
                                <li><a href="../classes/BuildURLMixin.html">BuildURLMixin</a></li>
                                <li><a href="../classes/Cache.html">Cache</a></li>
                                <li><a href="../classes/CacheCapabilitiesManager.html">CacheCapabilitiesManager</a></li>
                                <li><a href="../classes/CacheManager.html">CacheManager</a></li>
                                <li><a href="../classes/CanaryFeatureFlags.html">CanaryFeatureFlags</a></li>
                                <li><a href="../classes/ConflictError.html">ConflictError</a></li>
                                <li><a href="../classes/CurrentDeprecations.html">CurrentDeprecations</a></li>
                                <li><a href="../classes/DateTransform.html">DateTransform</a></li>
                                <li><a href="../classes/DebugLogging.html">DebugLogging</a></li>
                                <li><a href="../classes/Document.html">Document</a></li>
                                <li><a href="../classes/EmbeddedRecordsMixin.html">EmbeddedRecordsMixin</a></li>
                                <li><a href="../classes/Errors.html">Errors</a></li>
                                <li><a href="../classes/Fetch.html">Fetch</a></li>
                                <li><a href="../classes/ForbiddenError.html">ForbiddenError</a></li>
                                <li><a href="../classes/Future.html">Future</a></li>
                                <li><a href="../classes/HasManyReference.html">HasManyReference</a></li>
                                <li><a href="../classes/IdentifierCache.html">IdentifierCache</a></li>
                                <li><a href="../classes/InspectorDataAdapter.html">InspectorDataAdapter</a></li>
                                <li><a href="../classes/InvalidError.html">InvalidError</a></li>
                                <li><a href="../classes/JSONAPIAdapter.html">JSONAPIAdapter</a></li>
                                <li><a href="../classes/JSONAPISerializer.html">JSONAPISerializer</a></li>
                                <li><a href="../classes/JSONSerializer.html">JSONSerializer</a></li>
                                <li><a href="../classes/LifetimesService.html">LifetimesService</a></li>
                                <li><a href="../classes/ManyArray.html">ManyArray</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/NotFoundError.html">NotFoundError</a></li>
                                <li><a href="../classes/NotificationManager.html">NotificationManager</a></li>
                                <li><a href="../classes/NumberTransform.html">NumberTransform</a></li>
                                <li><a href="../classes/PromiseBelongsTo.html">PromiseBelongsTo</a></li>
                                <li><a href="../classes/PromiseManyArray.html">PromiseManyArray</a></li>
                                <li><a href="../classes/RecordArray.html">RecordArray</a></li>
                                <li><a href="../classes/RecordReference.html">RecordReference</a></li>
                                <li><a href="../classes/RequestManager.html">RequestManager</a></li>
                                <li><a href="../classes/RequestStateService.html">RequestStateService</a></li>
                                <li><a href="../classes/RESTAdapter.html">RESTAdapter</a></li>
                                <li><a href="../classes/RESTSerializer.html">RESTSerializer</a></li>
                                <li><a href="../classes/SchemaService.html">SchemaService</a></li>
                                <li><a href="../classes/Serializer.html">Serializer</a></li>
                                <li><a href="../classes/ServerError.html">ServerError</a></li>
                                <li><a href="../classes/Snapshot.html">Snapshot</a></li>
                                <li><a href="../classes/SnapshotRecordArray.html">SnapshotRecordArray</a></li>
                                <li><a href="../classes/StableRecordIdentifier.html">StableRecordIdentifier</a></li>
                                <li><a href="../classes/Store.html">Store</a></li>
                                <li><a href="../classes/StringTransform.html">StringTransform</a></li>
                                <li><a href="../classes/TimeoutError.html">TimeoutError</a></li>
                                <li><a href="../classes/Transform.html">Transform</a></li>
                                <li><a href="../classes/UnauthorizedError.html">UnauthorizedError</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/@ember-data_active-record_request.html">@ember-data/active-record/request</a></li>
                                <li><a href="../modules/@ember-data_adapter.html">@ember-data/adapter</a></li>
                                <li><a href="../modules/@ember-data_adapter_error.html">@ember-data/adapter/error</a></li>
                                <li><a href="../modules/@ember-data_adapter_json-api.html">@ember-data/adapter/json-api</a></li>
                                <li><a href="../modules/@ember-data_adapter_rest.html">@ember-data/adapter/rest</a></li>
                                <li><a href="../modules/@ember-data_canary-features.html">@ember-data/canary-features</a></li>
                                <li><a href="../modules/@ember-data_debug.html">@ember-data/debug</a></li>
                                <li><a href="../modules/@ember-data_deprecations.html">@ember-data/deprecations</a></li>
                                <li><a href="../modules/@ember-data_experimental-preview-types.html">@ember-data/experimental-preview-types</a></li>
                                <li><a href="../modules/@ember-data_graph.html">@ember-data/graph</a></li>
                                <li><a href="../modules/@ember-data_json-api.html">@ember-data/json-api</a></li>
                                <li><a href="../modules/@ember-data_json-api_request.html">@ember-data/json-api/request</a></li>
                                <li><a href="../modules/@ember-data_legacy-compat.html">@ember-data/legacy-compat</a></li>
                                <li><a href="../modules/@ember-data_model.html">@ember-data/model</a></li>
                                <li><a href="../modules/@ember-data_request.html">@ember-data/request</a></li>
                                <li><a href="../modules/@ember-data_request-utils.html">@ember-data/request-utils</a></li>
                                <li><a href="../modules/@ember-data_request_fetch.html">@ember-data/request/fetch</a></li>
                                <li><a href="../modules/@ember-data_rest_request.html">@ember-data/rest/request</a></li>
                                <li><a href="../modules/@ember-data_serializer.html">@ember-data/serializer</a></li>
                                <li><a href="../modules/@ember-data_serializer_json.html">@ember-data/serializer/json</a></li>
                                <li><a href="../modules/@ember-data_serializer_json-api.html">@ember-data/serializer/json-api</a></li>
                                <li><a href="../modules/@ember-data_serializer_rest.html">@ember-data/serializer/rest</a></li>
                                <li><a href="../modules/@ember-data_store.html">@ember-data/store</a></li>
                                <li><a href="../modules/@ember-data_tracking.html">@ember-data/tracking</a></li>
                                <li><a href="../modules/ember-data-overview.html">ember-data-overview</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../packages/store/src/-private/record-arrays/identifier-array.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
  @module @ember-data/store
*/
import { assert } from &#x27;@ember/debug&#x27;;

import { compat } from &#x27;@ember-data/tracking&#x27;;
import type { Signal } from &#x27;@ember-data/tracking/-private&#x27;;
import {
  addToTransaction,
  createArrayTags,
  createSignal,
  defineSignal,
  subscribe,
} from &#x27;@ember-data/tracking/-private&#x27;;
import type { StableRecordIdentifier } from &#x27;@warp-drive/core-types/identifier&#x27;;
import type { ImmutableRequestInfo } from &#x27;@warp-drive/core-types/request&#x27;;
import type { Links, PaginationLinks } from &#x27;@warp-drive/core-types/spec/raw&#x27;;

import type { RecordInstance } from &#x27;../../-types/q/record-instance&#x27;;
import { isStableIdentifier } from &#x27;../caches/identifier-cache&#x27;;
import { recordIdentifierFor } from &#x27;../caches/instance-cache&#x27;;
import type RecordArrayManager from &#x27;../managers/record-array-manager&#x27;;
import type Store from &#x27;../store-service&#x27;;

type KeyType = string | symbol | number;
const ARRAY_GETTER_METHODS = new Set&lt;KeyType&gt;([
  Symbol.iterator,
  &#x27;concat&#x27;,
  &#x27;entries&#x27;,
  &#x27;every&#x27;,
  &#x27;fill&#x27;,
  &#x27;filter&#x27;,
  &#x27;find&#x27;,
  &#x27;findIndex&#x27;,
  &#x27;flat&#x27;,
  &#x27;flatMap&#x27;,
  &#x27;forEach&#x27;,
  &#x27;includes&#x27;,
  &#x27;indexOf&#x27;,
  &#x27;join&#x27;,
  &#x27;keys&#x27;,
  &#x27;lastIndexOf&#x27;,
  &#x27;map&#x27;,
  &#x27;reduce&#x27;,
  &#x27;reduceRight&#x27;,
  &#x27;slice&#x27;,
  &#x27;some&#x27;,
  &#x27;values&#x27;,
]);
const ARRAY_SETTER_METHODS = new Set&lt;KeyType&gt;([&#x27;push&#x27;, &#x27;pop&#x27;, &#x27;unshift&#x27;, &#x27;shift&#x27;, &#x27;splice&#x27;, &#x27;sort&#x27;]);
const SYNC_PROPS = new Set&lt;KeyType&gt;([&#x27;[]&#x27;, &#x27;length&#x27;, &#x27;links&#x27;, &#x27;meta&#x27;]);
function isArrayGetter&lt;T&gt;(prop: KeyType): prop is keyof Array&lt;T&gt; {
  return ARRAY_GETTER_METHODS.has(prop);
}
function isArraySetter&lt;T&gt;(prop: KeyType): prop is keyof Array&lt;T&gt; {
  return ARRAY_SETTER_METHODS.has(prop);
}
function isSelfProp&lt;T extends object&gt;(self: T, prop: KeyType): prop is keyof T {
  return prop in self;
}

export const ARRAY_SIGNAL = Symbol(&#x27;#signal&#x27;);
export const SOURCE = Symbol(&#x27;#source&#x27;);
export const MUTATE = Symbol(&#x27;#update&#x27;);
export const NOTIFY = Symbol(&#x27;#notify&#x27;);
const IS_COLLECTION = Symbol.for(&#x27;Collection&#x27;);

export function notifyArray(arr: IdentifierArray) {
  addToTransaction(arr[ARRAY_SIGNAL]);
}

function convertToInt(prop: KeyType): number | null {
  if (typeof prop === &#x27;symbol&#x27;) return null;

  const num = Number(prop);

  if (isNaN(num)) return null;

  return num % 1 === 0 ? num : null;
}

type ProxiedMethod = (...args: unknown[]) =&gt; unknown;
declare global {
  interface ProxyConstructor {
    new &lt;TSource extends object, TTarget extends object&gt;(target: TSource, handler: ProxyHandler&lt;TSource&gt;): TTarget;
  }
}

export type IdentifierArrayCreateOptions = {
  identifiers: StableRecordIdentifier[];
  type?: string;
  store: Store;
  allowMutation: boolean;
  manager: RecordArrayManager;
  links?: Links | PaginationLinks | null;
  meta?: Record&lt;string, unknown&gt; | null;
};

interface PrivateState {
  links: Links | PaginationLinks | null;
  meta: Record&lt;string, unknown&gt; | null;
}
type ForEachCB = (record: RecordInstance, index: number, context: typeof Proxy&lt;StableRecordIdentifier[]&gt;) =&gt; void;
function safeForEach(
  instance: typeof Proxy&lt;StableRecordIdentifier[]&gt;,
  arr: StableRecordIdentifier[],
  store: Store,
  callback: ForEachCB,
  target: unknown
) {
  if (target === undefined) {
    target = null;
  }
  // clone to prevent mutation
  arr = arr.slice();
  assert(&#x27;&#x60;forEach&#x60; expects a function as first argument.&#x27;, typeof callback === &#x27;function&#x27;);

  // because we retrieveLatest above we need not worry if array is mutated during iteration
  // by unloadRecord/rollbackAttributes
  // push/add/removeObject may still be problematic
  // but this is a more traditionally expected forEach bug.
  const length = arr.length; // we need to access length to ensure we are consumed

  for (let index = 0; index &lt; length; index++) {
    callback.call(target, store._instanceCache.getRecord(arr[index]), index, instance);
  }

  return instance;
}

/**
  A record array is an array that contains records of a certain type (or modelName).
  The record array materializes records as needed when they are retrieved for the first
  time. You should not create record arrays yourself. Instead, an instance of
  &#x60;RecordArray&#x60; or its subclasses will be returned by your application&#x27;s store
  in response to queries.

  This class should not be imported and instantiated by consuming applications.

  @class RecordArray
  @public
*/
interface IdentifierArray extends Omit&lt;Array&lt;RecordInstance&gt;, &#x27;[]&#x27;&gt; {
  [MUTATE]?(
    target: StableRecordIdentifier[],
    receiver: typeof Proxy&lt;StableRecordIdentifier[]&gt;,
    prop: string,
    args: unknown[],
    _SIGNAL: Signal
  ): unknown;
}
class IdentifierArray {
  declare DEPRECATED_CLASS_NAME: string;
  /**
    The flag to signal a &#x60;RecordArray&#x60; is currently loading data.
    Example
    &#x60;&#x60;&#x60;javascript
    let people = store.peekAll(&#x27;person&#x27;);
    people.isUpdating; // false
    people.update();
    people.isUpdating; // true
    &#x60;&#x60;&#x60;
    @property isUpdating
    @public
    @type Boolean
  */
  declare isUpdating: boolean;
  isLoaded = true;
  isDestroying = false;
  isDestroyed = false;
  _updatingPromise: Promise&lt;IdentifierArray&gt; | null = null;

  [IS_COLLECTION] = true;
  declare [ARRAY_SIGNAL]: Signal;
  [SOURCE]: StableRecordIdentifier[];
  [NOTIFY]() {
    notifyArray(this);
  }

  declare links: Links | PaginationLinks | null;
  declare meta: Record&lt;string, unknown&gt; | null;
  declare modelName?: string;
  /**
    The store that created this record array.

    @property store
    @private
    @type Store
    */
  declare store: Store;
  declare _manager: RecordArrayManager;

  destroy(clear: boolean) {
    this.isDestroying = !clear;
    // changing the reference breaks the Proxy
    // this[SOURCE] = [];
    this[SOURCE].length = 0;
    this[NOTIFY]();
    this.isDestroyed = !clear;
  }

  // length must be on self for proxied methods to work properly
  @compat
  get length() {
    return this[SOURCE].length;
  }
  set length(value) {
    this[SOURCE].length = value;
  }

  constructor(options: IdentifierArrayCreateOptions) {
    // eslint-disable-next-line @typescript-eslint/no-this-alias
    const self = this;
    this.modelName = options.type;
    this.store = options.store;
    this._manager = options.manager;
    this[SOURCE] = options.identifiers;
    this[ARRAY_SIGNAL] = createSignal(this, &#x27;length&#x27;);
    const store = options.store;
    const boundFns = new Map&lt;KeyType, ProxiedMethod&gt;();
    const _SIGNAL = this[ARRAY_SIGNAL];
    const PrivateState: PrivateState = {
      links: options.links || null,
      meta: options.meta || null,
    };
    let transaction = false;

    // when a mutation occurs
    // we track all mutations within the call
    // and forward them as one

    const proxy = new Proxy&lt;StableRecordIdentifier[], RecordInstance[]&gt;(this[SOURCE], {
      get&lt;R extends typeof Proxy&lt;StableRecordIdentifier[]&gt;&gt;(
        target: StableRecordIdentifier[],
        prop: keyof R,
        receiver: R
      ): unknown {
        const index = convertToInt(prop);
        if (_SIGNAL.shouldReset &amp;&amp; (index !== null || SYNC_PROPS.has(prop) || isArrayGetter(prop))) {
          options.manager._syncArray(receiver as unknown as IdentifierArray);
          _SIGNAL.t = false;
          _SIGNAL.shouldReset = false;
        }

        if (index !== null) {
          const identifier = target[index];
          if (!transaction) {
            subscribe(_SIGNAL);
          }
          return identifier &amp;&amp; store._instanceCache.getRecord(identifier);
        }

        if (prop === &#x27;meta&#x27;) return subscribe(_SIGNAL), PrivateState.meta;
        if (prop === &#x27;links&#x27;) return subscribe(_SIGNAL), PrivateState.links;
        if (prop === &#x27;[]&#x27;) return subscribe(_SIGNAL), receiver;

        if (isArrayGetter(prop)) {
          let fn = boundFns.get(prop);

          if (fn === undefined) {
            if (prop === &#x27;forEach&#x27;) {
              fn = function () {
                subscribe(_SIGNAL);
                transaction = true;
                const result = safeForEach(receiver, target, store, arguments[0] as ForEachCB, arguments[1]);
                transaction = false;
                return result;
              };
            } else {
              fn = function () {
                subscribe(_SIGNAL);
                // array functions must run through Reflect to work properly
                // binding via other means will not work.
                transaction = true;
                const result = Reflect.apply(target[prop] as ProxiedMethod, receiver, arguments) as unknown;
                transaction = false;
                return result;
              };
            }

            boundFns.set(prop, fn);
          }

          return fn;
        }

        if (isArraySetter(prop)) {
          let fn = boundFns.get(prop);

          if (fn === undefined) {
            fn = function () {
              // array functions must run through Reflect to work properly
              // binding via other means will not work.
              if (!options.allowMutation) {
                assert(&#x60;Mutating this array of records via ${String(prop)} is not allowed.&#x60;, options.allowMutation);
                return;
              }
              const args: unknown[] = Array.prototype.slice.call(arguments);
              assert(&#x60;Cannot start a new array transaction while a previous transaction is underway&#x60;, !transaction);
              transaction = true;
              const result = self[MUTATE]!(target, receiver, prop as string, args, _SIGNAL);
              transaction = false;
              return result;
            };

            boundFns.set(prop, fn);
          }

          return fn;
        }

        if (isSelfProp(self, prop)) {
          if (prop === NOTIFY || prop === ARRAY_SIGNAL || prop === SOURCE) {
            return self[prop];
          }

          let fn = boundFns.get(prop);
          if (fn) return fn;

          const outcome: unknown = self[prop];

          if (typeof outcome === &#x27;function&#x27;) {
            fn = function () {
              subscribe(_SIGNAL);
              // array functions must run through Reflect to work properly
              // binding via other means will not work.
              return Reflect.apply(outcome as ProxiedMethod, receiver, arguments) as unknown;
            };

            boundFns.set(prop, fn);
            return fn;
          }

          return subscribe(_SIGNAL), outcome;
        }

        return target[prop as keyof StableRecordIdentifier[]];
      },

      // FIXME: Should this get a generic like get above?
      set(
        target: StableRecordIdentifier[],
        prop: KeyType,
        value: unknown,
        receiver: typeof Proxy&lt;StableRecordIdentifier[]&gt;
      ): boolean {
        if (prop === &#x27;length&#x27;) {
          if (!transaction &amp;&amp; value === 0) {
            transaction = true;
            self[MUTATE]!(target, receiver, &#x27;length 0&#x27;, [], _SIGNAL);
            transaction = false;
            return true;
          } else if (transaction) {
            return Reflect.set(target, prop, value);
          } else {
            assert(&#x60;unexpected length set&#x60;);
          }
        }
        if (prop === &#x27;links&#x27;) {
          PrivateState.links = (value || null) as PaginationLinks | Links | null;
          return true;
        }
        if (prop === &#x27;meta&#x27;) {
          PrivateState.meta = (value || null) as Record&lt;string, unknown&gt; | null;
          return true;
        }
        const index = convertToInt(prop);

        // we do not allow &quot;holey&quot; arrays and so if the index is
        // greater than length then we will disallow setting it.
        // however, there is a special case for &quot;unshift&quot; with more than
        // one item being inserted since current items will be moved to the
        // new indices first.
        // we &quot;loosely&quot; detect this by just checking whether we are in
        // a transaction.
        if (index === null || index &gt; target.length) {
          if (index !== null &amp;&amp; transaction) {
            const identifier = recordIdentifierFor(value);
            assert(&#x60;Cannot set index ${index} past the end of the array.&#x60;, isStableIdentifier(identifier));
            target[index] = identifier;
            return true;
          } else if (isSelfProp(self, prop)) {
            self[prop] = value;
            return true;
          }
          return false;
        }

        if (!options.allowMutation) {
          assert(&#x60;Mutating ${String(prop)} on this RecordArray is not allowed.&#x60;, options.allowMutation);
          return false;
        }

        const original: StableRecordIdentifier | undefined = target[index];
        const newIdentifier = extractIdentifierFromRecord(value);
        (target as unknown as Record&lt;KeyType, unknown&gt;)[index] = newIdentifier;
        assert(&#x60;Expected a record&#x60;, isStableIdentifier(newIdentifier));
        // We generate &quot;transactions&quot; whenever a setter method on the array
        // is called and might bulk update multiple array cells. Fundamentally,
        // all array operations decompose into individual cell replacements.
        // e.g. a push is really a &quot;replace cell at next index with new value&quot;
        // or a splice is &quot;shift all values left/right by X and set out of new
        // bounds cells to undefined&quot;
        //
        // so, if we are in a transaction, then this is not a user generated change
        // but one generated by a setter method. In this case we want to only apply
        // the change to the target array and not call the MUTATE method.
        // If there is no transaction though, then this means the user themselves has
        // directly changed the value of a specific index and we need to thus generate
        // a mutation for that change.
        // e.g. &quot;arr.push(newVal)&quot; is handled by a &quot;addToRelatedRecords&quot; mutation within
        // a transaction.
        // while &quot;arr[arr.length] = newVal;&quot; is handled by this replace cell code path.
        if (!transaction) {
          self[MUTATE]!(target, receiver, &#x27;replace cell&#x27;, [index, original, newIdentifier], _SIGNAL);
        } else {
          target[index] = newIdentifier;
        }

        return true;
      },

      deleteProperty(target: StableRecordIdentifier[], prop: string | symbol): boolean {
        assert(&#x60;Deleting keys on managed arrays is disallowed&#x60;, transaction);
        if (!transaction) {
          return false;
        }
        return Reflect.deleteProperty(target, prop);
      },

      getPrototypeOf() {
        return IdentifierArray.prototype;
      },
    }) as IdentifierArray;

    createArrayTags(proxy, _SIGNAL);

    this[NOTIFY] = this[NOTIFY].bind(proxy);

    return proxy;
  }

  /**
    Used to get the latest version of all of the records in this array
    from the adapter.

    Example

    &#x60;&#x60;&#x60;javascript
    let people = store.peekAll(&#x27;person&#x27;);
    people.isUpdating; // false

    people.update().then(function() {
      people.isUpdating; // false
    });

    people.isUpdating; // true
    &#x60;&#x60;&#x60;

    @method update
    @public
  */
  update(): Promise&lt;IdentifierArray&gt; {
    if (this.isUpdating) {
      return this._updatingPromise!;
    }

    this.isUpdating = true;

    const updatingPromise = this._update();
    void updatingPromise.finally(() =&gt; {
      this._updatingPromise = null;
      if (this.isDestroying || this.isDestroyed) {
        return;
      }
      this.isUpdating = false;
    });

    this._updatingPromise = updatingPromise;

    return updatingPromise;
  }

  /*
    Update this RecordArray and return a promise which resolves once the update
    is finished.
   */
  _update(): Promise&lt;IdentifierArray&gt; {
    assert(&#x60;_update cannot be used with this array&#x60;, this.modelName);
    return this.store.findAll(this.modelName, { reload: true });
  }

  // TODO deprecate
  /**
    Saves all of the records in the &#x60;RecordArray&#x60;.

    Example

    &#x60;&#x60;&#x60;javascript
    let messages = store.peekAll(&#x27;message&#x27;);
    messages.forEach(function(message) {
      message.hasBeenSeen = true;
    });
    messages.save();
    &#x60;&#x60;&#x60;

    @method save
    @public
    @return {Promise&lt;IdentifierArray&gt;} promise
  */
  save(): Promise&lt;IdentifierArray&gt; {
    const promise = Promise.all(this.map((record) =&gt; this.store.saveRecord(record))).then(() =&gt; this);

    return promise;
  }
}

// this will error if someone tries to call
// A(identifierArray) since it is not configurable
// which is preferable to the &#x60;meta&#x60; override we used
// before which required importing all of Ember
const desc = {
  enumerable: true,
  configurable: false,
  get: function () {
    return this;
  },
};
compat(desc);
Object.defineProperty(IdentifierArray.prototype, &#x27;[]&#x27;, desc);

defineSignal(IdentifierArray.prototype, &#x27;isUpdating&#x27;, false);

export default IdentifierArray;

export type CollectionCreateOptions = IdentifierArrayCreateOptions &amp; {
  query: ImmutableRequestInfo | Record&lt;string, unknown&gt; | null;
  isLoaded: boolean;
};

export class Collection extends IdentifierArray {
  query: ImmutableRequestInfo | Record&lt;string, unknown&gt; | null = null;

  constructor(options: CollectionCreateOptions) {
    super(options as IdentifierArrayCreateOptions);
    this.query = options.query || null;
    this.isLoaded = options.isLoaded || false;
  }

  _update(): Promise&lt;Collection&gt; {
    const { store, query } = this;

    // TODO save options from initial request?
    assert(&#x60;update cannot be used with this array&#x60;, this.modelName);
    assert(&#x60;update cannot be used with no query&#x60;, query);
    const promise = store.query(this.modelName, query as Record&lt;string, unknown&gt;, { _recordArray: this });

    return promise;
  }

  destroy(clear: boolean) {
    super.destroy(clear);
    this._manager._managed.delete(this);
    this._manager._pending.delete(this);
  }
}
// trick the proxy &quot;in&quot; check
Collection.prototype.query = null;

// Ensure instanceof works correctly
// Object.setPrototypeOf(IdentifierArray.prototype, Array.prototype);

type PromiseProxyRecord = { then(): void; content: RecordInstance | null | undefined };

function assertRecordPassedToHasMany(record: RecordInstance | PromiseProxyRecord) {
  assert(
    &#x60;All elements of a hasMany relationship must be instances of Model, you passed $${typeof record}&#x60;,
    (function () {
      try {
        recordIdentifierFor(record);
        return true;
      } catch {
        return false;
      }
    })()
  );
}

function extractIdentifierFromRecord(record: PromiseProxyRecord | RecordInstance | null) {
  if (!record) {
    return null;
  }

  assertRecordPassedToHasMany(record);
  return recordIdentifierFor(record);
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
