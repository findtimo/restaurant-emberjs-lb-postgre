{"version":3,"file":"webpack.js","sourceRoot":"","sources":["../ts/webpack.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  Configuration,\n  Compiler,\n  RuleSetRule,\n  Stats,\n  RuleSetUseItem,\n  WebpackPluginInstance,\n  Module,\n} from 'webpack';\nimport { join, dirname, resolve, relative, posix, isAbsolute } from 'path';\nimport { createHash } from 'crypto';\nimport { mergeWith, flatten, zip } from 'lodash';\nimport { writeFileSync, realpathSync, readFileSync } from 'fs';\nimport { compile, registerHelper } from 'handlebars';\nimport jsStringEscape from 'js-string-escape';\nimport { BundleDependencies, ResolvedTemplateImport } from './splitter';\nimport { BuildResult, Bundler, BundlerOptions } from './bundler';\nimport type { InputNode } from 'broccoli-node-api';\nimport Plugin from 'broccoli-plugin';\nimport { babelFilter, packageName, Package } from '@embroider/shared-internals';\nimport { Options } from './package';\nimport { PackageCache } from '@embroider/shared-internals';\nimport { Memoize } from 'typescript-memoize';\nimport makeDebug from 'debug';\nimport { ensureDirSync, symlinkSync, existsSync } from 'fs-extra';\nimport MiniCssExtractPlugin from 'mini-css-extract-plugin';\nimport minimatch from 'minimatch';\nimport { TransformOptions } from '@babel/core';\nimport { stripQuery } from './util';\n\nconst EXTENSIONS = ['.js', '.ts', '.json'];\n\nconst debug = makeDebug('ember-auto-import:webpack');\n\nregisterHelper('js-string-escape', jsStringEscape);\nregisterHelper('join', function (list, connector) {\n  return list.join(connector);\n});\n\nconst moduleIdMap = new Map<string, string>();\n\nfunction moduleToId(moduleSpecifier: string) {\n  let id = moduleSpecifier;\n\n  // if the module contains characters that need to be escaped, then map this to a hash instead, so we can easily replace this later\n  if (moduleSpecifier.includes('\"') || moduleSpecifier.includes(\"'\")) {\n    id = createHash('md5').update('some_string').digest('hex');\n\n    moduleIdMap.set(id, moduleSpecifier);\n  }\n\n  return id;\n}\n\nfunction idToModule(id: string) {\n  return moduleIdMap.get(id) ?? id;\n}\n\nregisterHelper('module-to-id', moduleToId);\n\nconst entryTemplate = compile(\n  `\nmodule.exports = (function(){\n  var d = _eai_d;\n  var r = _eai_r;\n  window.emberAutoImportDynamic = function(specifier) {\n    if (arguments.length === 1) {\n      return r('_eai_dyn_' + specifier);\n    } else {\n      return r('_eai_dynt_' + specifier)(Array.prototype.slice.call(arguments, 1))\n    }\n  };\n  window.emberAutoImportSync = function(specifier) {\n    {{! this is only used for synchronous importSync() using a template string }}\n    return r('_eai_sync_' + specifier)(Array.prototype.slice.call(arguments, 1))\n  };\n  {{!- es compatibility. Where we're using \"require\", webpack doesn't necessarily know to apply its own ES compatibility stuff -}}\n  function esc(m) {\n    return m && m.__esModule ? m : Object.assign({ default: m }, m);\n  }\n  {{#each staticImports as |module|}}\n    d('{{js-string-escape module.specifier}}', EAI_DISCOVERED_EXTERNALS('{{module-to-id module.specifier}}'), function() { return esc(require('{{js-string-escape module.specifier}}')); });\n  {{/each}}\n  {{#each dynamicImports as |module|}}\n    d('_eai_dyn_{{js-string-escape module.specifier}}', [], function() { return import('{{js-string-escape module.specifier}}'); });\n  {{/each}}\n  {{#each staticTemplateImports as |module|}}\n    d('_eai_sync_{{js-string-escape module.key}}', [], function() {\n      return function({{module.args}}) {\n        return esc(require({{{module.template}}}));\n      }\n    });\n  {{/each}}\n  {{#each dynamicTemplateImports as |module|}}\n    d('_eai_dynt_{{js-string-escape module.key}}', [], function() {\n      return function({{module.args}}) {\n        return import({{{module.template}}});\n      }\n    });\n  {{/each}}\n})();\n`,\n  { noEscape: true }\n) as (args: {\n  staticImports: { specifier: string }[];\n  dynamicImports: { specifier: string }[];\n  staticTemplateImports: { key: string; args: string; template: string }[];\n  dynamicTemplateImports: { key: string; args: string; template: string }[];\n  publicAssetURL: string | undefined;\n}) => string;\n\n// this goes in a file by itself so we can tell webpack not to parse it. That\n// allows us to grab the \"require\" and \"define\" from our enclosing scope without\n// webpack messing with them.\n//\n// It's important that we're using our enclosing scope and not jumping directly\n// to window.require (which would be easier), because the entire Ember app may be\n// inside a closure with a \"require\" that isn't the same as \"window.require\".\nconst loader = `\nwindow._eai_r = require;\nwindow._eai_d = define;\n`;\n\nexport default class WebpackBundler extends Plugin implements Bundler {\n  private state:\n    | {\n        webpack: Compiler;\n        stagingDir: string;\n      }\n    | undefined;\n\n  private lastBuildResult: BuildResult | undefined;\n\n  constructor(priorTrees: InputNode[], private opts: BundlerOptions) {\n    super(priorTrees, {\n      persistentOutput: true,\n      needsCache: true,\n      annotation: 'ember-auto-import-webpack',\n    });\n  }\n\n  get buildResult() {\n    if (!this.lastBuildResult) {\n      throw new Error(`bug: no buildResult available yet`);\n    }\n    return this.lastBuildResult;\n  }\n\n  private get webpack() {\n    return this.setup().webpack;\n  }\n\n  private get stagingDir() {\n    return this.setup().stagingDir;\n  }\n\n  private setup() {\n    if (this.state) {\n      return this.state;\n    }\n\n    // resolve the real path, because we're going to do path comparisons later\n    // that could fail if this is not canonical.\n    //\n    // cast is ok because we passed needsCache to super\n    let stagingDir = realpathSync(this.cachePath!);\n\n    let entry: { [name: string]: string[] } = {};\n    this.opts.bundles.names.forEach((bundle) => {\n      entry[bundle] = [\n        join(stagingDir, 'l.cjs'),\n        join(stagingDir, `${bundle}.cjs`),\n      ];\n    });\n\n    let { plugin: stylePlugin, loader: styleLoader } = this.setupStyleLoader();\n\n    let config: Configuration = {\n      mode:\n        this.opts.environment === 'production' ? 'production' : 'development',\n      entry,\n      performance: {\n        hints: false,\n      },\n      // this controls webpack's own runtime code generation. You still need\n      // preset-env to preprocess the libraries themselves (which is already\n      // part of this.opts.babelConfig)\n      target: `browserslist:${this.opts.rootPackage.browserslist()}`,\n      output: {\n        path: join(this.outputPath, 'assets'),\n        publicPath: this.opts.rootPackage.publicAssetURL(),\n        filename: `chunk.[id].[chunkhash].js`,\n        chunkFilename: `chunk.[id].[chunkhash].js`,\n        libraryTarget: 'var',\n        library: '__ember_auto_import__',\n      },\n      optimization: {\n        splitChunks: {\n          chunks: 'all',\n        },\n      },\n      resolveLoader: {\n        alias: {\n          // these loaders are our dependencies, not the app's dependencies. I'm\n          // not overriding the default loader resolution rules in case the app also\n          // wants to control those.\n          'babel-loader-8': require.resolve('babel-loader'),\n          'eai-style-loader': require.resolve('style-loader'),\n          'eai-css-loader': require.resolve('css-loader'),\n        },\n      },\n      resolve: {\n        extensions: EXTENSIONS,\n        mainFields: ['browser', 'module', 'main'],\n        alias: Object.assign(\n          {\n            // this is because of the allowAppImports feature needs to be able to import things\n            // like app-name/lib/something from within webpack handled code but that needs to be\n            // able to resolve to app-root/app/lib/something.\n            [this.opts.rootPackage.name]: `${this.opts.rootPackage.root}/app`,\n          },\n          ...removeUndefined([...this.opts.packages].map((pkg) => pkg.aliases))\n        ),\n      },\n      plugins: removeUndefined([stylePlugin]),\n      module: {\n        noParse: (file: string) => file === join(stagingDir, 'l.cjs'),\n        rules: [\n          this.babelRule(\n            stagingDir,\n            (filename) => !this.fileIsInApp(filename),\n            this.opts.rootPackage.cleanBabelConfig()\n          ),\n          this.babelRule(\n            stagingDir,\n            (filename) => this.fileIsInApp(filename),\n            this.opts.rootPackage.babelOptions\n          ),\n          {\n            test: /\\.css$/i,\n            use: [\n              styleLoader,\n              {\n                loader: 'eai-css-loader',\n                options: [...this.opts.packages].find(\n                  (pkg) => pkg.cssLoaderOptions\n                )?.cssLoaderOptions,\n              },\n            ],\n          },\n        ],\n      },\n      node: false,\n      externals: this.externalsHandler,\n    };\n    if ([...this.opts.packages].find((pkg) => pkg.forbidsEval)) {\n      config.devtool = 'source-map';\n    }\n    mergeConfig(\n      config,\n      ...[...this.opts.packages].map((pkg) => pkg.webpackConfig)\n    );\n    debug('webpackConfig %j', config);\n    this.state = { webpack: this.opts.webpack(config), stagingDir };\n    return this.state;\n  }\n\n  private setupStyleLoader(): {\n    loader: RuleSetUseItem;\n    plugin: WebpackPluginInstance | undefined;\n  } {\n    if (\n      this.opts.environment === 'production' ||\n      this.opts.rootPackage.isFastBootEnabled\n    ) {\n      return {\n        loader: MiniCssExtractPlugin.loader,\n        plugin: new MiniCssExtractPlugin({\n          filename: `chunk.[id].[chunkhash].css`,\n          chunkFilename: `chunk.[id].[chunkhash].css`,\n          ...[...this.opts.packages].find(\n            (pkg) => pkg.miniCssExtractPluginOptions\n          )?.miniCssExtractPluginOptions,\n        }),\n      };\n    } else\n      return {\n        loader: {\n          loader: 'eai-style-loader',\n          options: [...this.opts.packages].find((pkg) => pkg.styleLoaderOptions)\n            ?.styleLoaderOptions,\n        },\n        plugin: undefined,\n      };\n  }\n\n  private skipBabel(): Required<Options>['skipBabel'] {\n    let output: Required<Options>['skipBabel'] = [];\n    for (let pkg of this.opts.packages) {\n      let skip = pkg.skipBabel;\n      if (skip) {\n        output = output.concat(skip);\n      }\n    }\n    return output;\n  }\n\n  private fileIsInApp(filename: string) {\n    let packageCache = PackageCache.shared(\n      'ember-auto-import',\n      this.opts.rootPackage.root\n    );\n\n    const pkg = packageCache.ownerOfFile(filename);\n\n    return pkg?.root === this.opts.rootPackage.root;\n  }\n\n  private babelRule(\n    stagingDir: string,\n    filter: (filename: string) => boolean,\n    babelConfig: TransformOptions\n  ): RuleSetRule {\n    let shouldTranspile = babelFilter(\n      this.skipBabel(),\n      this.opts.rootPackage.root\n    );\n\n    return {\n      test: (filename: string) => {\n        // We don't apply babel to our own stagingDir (it contains only our own\n        // entrypoints that we wrote, and it can use `import()`, which we want\n        // to leave directly for webpack).\n        //\n        // And we otherwise defer to the `skipBabel` setting as implemented by\n        // `@embroider/shared-internals`.\n        return (\n          dirname(filename) !== stagingDir &&\n          shouldTranspile(filename) &&\n          filter(filename)\n        );\n      },\n      use: {\n        loader: 'babel-loader-8',\n        options: babelConfig,\n      },\n    };\n  }\n\n  private externalizedByUs = new Set<string>();\n\n  @Memoize()\n  private get externalsHandler(): Configuration['externals'] {\n    let packageCache = PackageCache.shared(\n      'ember-auto-import',\n      this.opts.rootPackage.root\n    );\n    return (params, callback) => {\n      let { context, request, contextInfo } = params;\n      if (!context || !request) {\n        return callback();\n      }\n\n      if (request.startsWith('!')) {\n        return callback();\n      }\n\n      let pkg = packageCache.ownerOfFile(context);\n      if (!pkg) {\n        // we're not inside any identifiable NPM package\n        return callback();\n      }\n\n      let name = packageName(request);\n      if (!name) {\n        if (!isAbsolute(request) && pkg.root === this.opts.rootPackage.root) {\n          let appRelativeContext = relative(\n            resolve(this.opts.rootPackage.root, 'app'),\n            context\n          );\n\n          name = this.opts.rootPackage.name;\n          let candidateName = posix.join(name, appRelativeContext, request);\n          if (candidateName.startsWith(name)) {\n            request = candidateName;\n          } else {\n            // the relative request does not target the traditional \"app\" dir\n            return callback();\n          }\n        } else {\n          // we're only interested in handling inter-package resolutions\n          return callback();\n        }\n      }\n\n      // Handling full-name imports that point at the app itself e.g. app-name/lib/thingy\n      if (name === this.opts.rootPackage.name) {\n        if (\n          this.importMatchesAppImports(\n            stripQuery(request.slice(name.length + 1))\n          )\n        ) {\n          // webpack should handle this because it's another file in the app that matches allowAppImports\n          return callback();\n        } else {\n          // use ember's module because this is part of the app that doesn't match allowAppImports\n          this.externalizedByUs.add(request);\n          return callback(undefined, 'commonjs ' + request);\n        }\n      }\n\n      // if we're not in a v2 addon and the file that is doing the import doesn't match one of the allowAppImports patterns\n      // then we don't implement the \"fallback behaviour\" below i.e. this won't be handled by ember-auto-import\n      if (\n        !pkg.isV2Addon() &&\n        !this.matchesAppImports(pkg, contextInfo?.issuer)\n      ) {\n        return callback();\n      }\n\n      if (pkg.isV2Addon() && pkg.meta.externals?.includes(name)) {\n        this.externalizedByUs.add(request);\n        return callback(undefined, 'commonjs ' + request);\n      }\n\n      try {\n        let found = packageCache.resolve(name, pkg);\n        if (!found.isEmberPackage() || found.isV2Addon()) {\n          // if we're importing a non-ember package or a v2 addon, we don't\n          // externalize. Those are all \"normal\" looking packages that should be\n          // resolvable statically.\n          return callback();\n        } else {\n          // the package exists but it is a v1 ember addon, so it's not\n          // resolvable at build time, so we externalize it.\n          this.externalizedByUs.add(request);\n          return callback(undefined, 'commonjs ' + request);\n        }\n      } catch (err) {\n        if (err.code !== 'MODULE_NOT_FOUND') {\n          throw err;\n        }\n        // real package doesn't exist, so externalize it\n        this.externalizedByUs.add(request);\n        return callback(undefined, 'commonjs ' + request);\n      }\n    };\n  }\n\n  *withResolvableExtensions(\n    importSpecifier: string\n  ): Generator<string, void, void> {\n    if (importSpecifier.match(/\\.\\w+$/)) {\n      yield importSpecifier;\n    } else {\n      for (let ext of EXTENSIONS) {\n        yield `${importSpecifier}${ext}`;\n      }\n    }\n  }\n\n  importMatchesAppImports(relativeImportSpecifier: string): boolean {\n    for (let candidate of this.withResolvableExtensions(\n      relativeImportSpecifier\n    )) {\n      if (\n        this.opts.rootPackage.allowAppImports.some((pattern) =>\n          minimatch(candidate, pattern)\n        )\n      ) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  matchesAppImports(pkg: Package, requestingFile: string | undefined): boolean {\n    if (!requestingFile) {\n      return false;\n    }\n\n    if (pkg.root !== this.opts.rootPackage.root) {\n      return false;\n    }\n\n    return this.opts.rootPackage.allowAppImports.some((pattern) =>\n      minimatch(relative(join(pkg.root, 'app'), requestingFile), pattern)\n    );\n  }\n\n  async build(): Promise<void> {\n    let bundleDeps = await this.opts.splitter.deps();\n\n    for (let [bundle, deps] of bundleDeps.entries()) {\n      this.writeEntryFile(bundle, deps);\n    }\n    this.writeLoaderFile();\n    this.linkDeps(bundleDeps);\n    let stats = await this.runWebpack();\n    this.lastBuildResult = this.summarizeStats(stats, bundleDeps);\n    this.addDiscoveredExternals(this.lastBuildResult);\n  }\n\n  private addDiscoveredExternals(build: BuildResult) {\n    for (let assetFiles of build.entrypoints.values()) {\n      for (let assetFile of assetFiles) {\n        let inputSrc = readFileSync(\n          resolve(this.outputPath, assetFile),\n          'utf8'\n        );\n        let outputSrc = inputSrc.replace(\n          /EAI_DISCOVERED_EXTERNALS\\(['\"]([^'\"]+)['\"]\\)/g,\n          (_substr: string, matched: string) => {\n            let deps = build\n              .externalDepsFor(idToModule(matched))\n              .filter((dep) => this.externalizedByUs.has(dep));\n            return '[' + deps.map((d) => `'${d}'`).join(',') + ']';\n          }\n        );\n        writeFileSync(resolve(this.outputPath, assetFile), outputSrc, 'utf8');\n      }\n    }\n  }\n\n  private externalDepsSearcher(\n    stats: Required<Stats>\n  ): (request: string) => string[] {\n    let externals = new Map<Module, Set<string>>();\n\n    function gatherExternals(\n      module: Module,\n      output = new Set<string>()\n    ): Set<string> {\n      if (externals.has(module)) {\n        for (let ext of externals.get(module)!) {\n          output.add(ext);\n        }\n      } else {\n        let ownExternals = new Set<string>();\n        externals.set(module, ownExternals);\n        for (let dep of module.dependencies) {\n          let nextModule = stats.compilation.moduleGraph.getModule(dep);\n          if (nextModule) {\n            if ((nextModule as any).externalType) {\n              ownExternals.add((nextModule as any).request);\n            } else {\n              gatherExternals(nextModule, ownExternals);\n            }\n          }\n        }\n        for (let o of ownExternals) {\n          output.add(o);\n        }\n      }\n      return output;\n    }\n\n    return (request: string): string[] => {\n      for (let module of stats.compilation.modules) {\n        for (let dep of module.dependencies) {\n          if ((dep as any).request === request) {\n            return [\n              ...gatherExternals(stats.compilation.moduleGraph.getModule(dep)!),\n            ];\n          }\n        }\n      }\n      return [];\n    };\n  }\n\n  private summarizeStats(\n    _stats: Required<Stats>,\n    bundleDeps: Map<string, BundleDependencies>\n  ): BuildResult {\n    let { entrypoints, assets } = _stats.toJson();\n\n    // webpack's types are written rather loosely, implying that these two\n    // properties may not be present. They really always are, as far as I can\n    // tell, but we need to check here anyway to satisfy the type checker.\n    if (!entrypoints) {\n      throw new Error(`unexpected webpack output: no entrypoints`);\n    }\n    if (!assets) {\n      throw new Error(`unexpected webpack output: no assets`);\n    }\n\n    let output: BuildResult = {\n      entrypoints: new Map(),\n      lazyAssets: [] as string[],\n      externalDepsFor: this.externalDepsSearcher(_stats),\n    };\n    let nonLazyAssets: Set<string> = new Set();\n    for (let id of Object.keys(entrypoints!)) {\n      let { assets: entrypointAssets } = entrypoints![id];\n      if (!entrypointAssets) {\n        throw new Error(`unexpected webpack output: no entrypoint.assets`);\n      }\n\n      // our built-in bundles can be \"empty\" while still existing because we put\n      // setup code in them, so they get a special check for non-emptiness.\n      // Whereas any other bundle that was manually configured by the user\n      // should always be emitted.\n      if (\n        !this.opts.bundles.isBuiltInBundleName(id) ||\n        nonEmptyBundle(id, bundleDeps)\n      ) {\n        output.entrypoints.set(\n          id,\n          entrypointAssets.map((a) => 'assets/' + a.name)\n        );\n      }\n      entrypointAssets.forEach((asset) => nonLazyAssets.add(asset.name));\n    }\n    for (let asset of assets!) {\n      if (!nonLazyAssets.has(asset.name)) {\n        output.lazyAssets.push('assets/' + asset.name);\n      }\n    }\n    return output;\n  }\n\n  private writeEntryFile(name: string, deps: BundleDependencies) {\n    writeFileSync(\n      join(this.stagingDir, `${name}.cjs`),\n      entryTemplate({\n        staticImports: deps.staticImports,\n        dynamicImports: deps.dynamicImports,\n        dynamicTemplateImports:\n          deps.dynamicTemplateImports.map(mapTemplateImports),\n        staticTemplateImports:\n          deps.staticTemplateImports.map(mapTemplateImports),\n        publicAssetURL: this.opts.rootPackage.publicAssetURL(),\n      })\n    );\n  }\n\n  private writeLoaderFile() {\n    writeFileSync(join(this.stagingDir, `l.cjs`), loader);\n  }\n\n  private linkDeps(bundleDeps: Map<string, BundleDependencies>) {\n    for (let deps of bundleDeps.values()) {\n      for (let resolved of deps.staticImports) {\n        this.ensureLinked(resolved);\n      }\n      for (let resolved of deps.dynamicImports) {\n        this.ensureLinked(resolved);\n      }\n      for (let resolved of deps.staticTemplateImports) {\n        this.ensureLinked(resolved);\n      }\n      for (let resolved of deps.dynamicTemplateImports) {\n        this.ensureLinked(resolved);\n      }\n    }\n  }\n\n  private ensureLinked({\n    packageName,\n    packageRoot,\n  }: {\n    packageName: string;\n    packageRoot: string;\n  }): void {\n    ensureDirSync(dirname(join(this.stagingDir, 'node_modules', packageName)));\n    if (!existsSync(join(this.stagingDir, 'node_modules', packageName))) {\n      symlinkSync(\n        packageRoot,\n        join(this.stagingDir, 'node_modules', packageName),\n        'junction'\n      );\n    }\n  }\n\n  private async runWebpack(): Promise<Required<Stats>> {\n    return new Promise((resolve, reject) => {\n      this.webpack.run((err, stats) => {\n        const statsString = stats ? stats.toString() : '';\n        if (err) {\n          this.opts.consoleWrite(statsString);\n          reject(err);\n          return;\n        }\n        if (stats?.hasErrors()) {\n          this.opts.consoleWrite(statsString);\n          reject(new Error('webpack returned errors to ember-auto-import'));\n          return;\n        }\n        if (stats?.hasWarnings() || process.env.AUTO_IMPORT_VERBOSE) {\n          this.opts.consoleWrite(statsString);\n        }\n        // this cast is justified because we already checked hasErrors above\n        resolve(stats as Required<Stats>);\n      });\n    }) as Promise<Required<Stats>>;\n  }\n}\n\nexport function mergeConfig(dest: Configuration, ...srcs: Configuration[]) {\n  return mergeWith(dest, ...srcs, combine);\n}\n\nfunction combine(objValue: any, srcValue: any, key: string) {\n  if (key === 'noParse') {\n    return eitherPattern(objValue, srcValue);\n  }\n\n  if (key === 'externals') {\n    return [srcValue, objValue].flat();\n  }\n\n  // arrays concat\n  if (Array.isArray(objValue)) {\n    return objValue.concat(srcValue);\n  }\n}\n\n// webpack configs have several places where they accept:\n//   - RegExp\n//   - [RegExp]\n//   - (resource: string) => boolean\n//   - string\n//   - [string]\n// This function combines any of these with a logical OR.\nfunction eitherPattern(...patterns: any[]): (resource: string) => boolean {\n  let flatPatterns = flatten(patterns);\n  return function (resource) {\n    for (let pattern of flatPatterns) {\n      if (pattern instanceof RegExp) {\n        if (pattern.test(resource)) {\n          return true;\n        }\n      } else if (typeof pattern === 'string') {\n        if (pattern === resource) {\n          return true;\n        }\n      } else if (typeof pattern === 'function') {\n        if (pattern(resource)) {\n          return true;\n        }\n      }\n    }\n    return false;\n  };\n}\n\nfunction mapTemplateImports(imp: ResolvedTemplateImport) {\n  return {\n    key: imp.importedBy[0].cookedQuasis.join('${e}'),\n    args: imp.expressionNameHints.join(','),\n    template:\n      '`' +\n      zip(imp.cookedQuasis, imp.expressionNameHints)\n        .map(([q, e]) => q + (e ? '${' + e + '}' : ''))\n        .join('') +\n      '`',\n  };\n}\n\nfunction nonEmptyBundle(\n  name: string,\n  bundleDeps: Map<string, BundleDependencies>\n): boolean {\n  let deps = bundleDeps.get(name);\n  if (!deps) {\n    return false;\n  }\n  return (\n    deps.staticImports.length > 0 ||\n    deps.staticTemplateImports.length > 0 ||\n    deps.dynamicImports.length > 0 ||\n    deps.dynamicTemplateImports.length > 0\n  );\n}\n\n// this little helper is needed because typescript can't see through normal\n// usage of Array.prototype.filter.\nfunction removeUndefined<T>(list: (T | undefined)[]): T[] {\n  return list.filter((item) => typeof item !== 'undefined') as T[];\n}\n"]}