{"version":3,"file":"map.js","sources":["../../src/-private/map.ts"],"sourcesContent":["import {\n  TrackedStorage,\n  createStorage,\n  getValue,\n  setValue,\n} from 'ember-tracked-storage-polyfill';\n\nexport class TrackedMap<K = unknown, V = unknown> implements Map<K, V> {\n  private collection = createStorage(null, () => false);\n\n  private storages: Map<K, TrackedStorage<null>> = new Map();\n\n  private vals: Map<K, V>;\n\n  private readStorageFor(key: K): void {\n    const { storages } = this;\n    let storage = storages.get(key);\n\n    if (storage === undefined) {\n      storage = createStorage(null, () => false);\n      storages.set(key, storage);\n    }\n\n    getValue(storage);\n  }\n\n  private dirtyStorageFor(key: K): void {\n    const storage = this.storages.get(key);\n\n    if (storage) {\n      setValue(storage, null);\n    }\n  }\n\n  constructor();\n  constructor(entries: readonly (readonly [K, V])[] | null);\n  constructor(iterable: Iterable<readonly [K, V]>);\n  constructor(\n    existing?:\n      | readonly (readonly [K, V])[]\n      | Iterable<readonly [K, V]>\n      | null\n      | undefined\n  ) {\n    // TypeScript doesn't correctly resolve the overloads for calling the `Map`\n    // constructor for the no-value constructor. This resolves that.\n    this.vals = existing ? new Map(existing) : new Map();\n  }\n\n  // **** KEY GETTERS ****\n  get(key: K): V | undefined {\n    // entangle the storage for the key\n    this.readStorageFor(key);\n\n    return this.vals.get(key);\n  }\n\n  has(key: K): boolean {\n    this.readStorageFor(key);\n\n    return this.vals.has(key);\n  }\n\n  // **** ALL GETTERS ****\n  entries(): IterableIterator<[K, V]> {\n    getValue(this.collection);\n\n    return this.vals.entries();\n  }\n\n  keys(): IterableIterator<K> {\n    getValue(this.collection);\n\n    return this.vals.keys();\n  }\n\n  values(): IterableIterator<V> {\n    getValue(this.collection);\n\n    return this.vals.values();\n  }\n\n  forEach(fn: (value: V, key: K, map: Map<K, V>) => void): void {\n    getValue(this.collection);\n\n    this.vals.forEach(fn);\n  }\n\n  get size(): number {\n    getValue(this.collection);\n\n    return this.vals.size;\n  }\n\n  [Symbol.iterator](): IterableIterator<[K, V]> {\n    getValue(this.collection);\n\n    return this.vals[Symbol.iterator]();\n  }\n\n  get [Symbol.toStringTag](): string {\n    return this.vals[Symbol.toStringTag];\n  }\n\n  // **** KEY SETTERS ****\n  set(key: K, value: V): this {\n    this.dirtyStorageFor(key);\n    setValue(this.collection, null);\n\n    this.vals.set(key, value);\n\n    return this;\n  }\n\n  delete(key: K): boolean {\n    this.dirtyStorageFor(key);\n    setValue(this.collection, null);\n\n    return this.vals.delete(key);\n  }\n\n  // **** ALL SETTERS ****\n  clear(): void {\n    this.storages.forEach((s) => setValue(s, null));\n    setValue(this.collection, null);\n\n    this.vals.clear();\n  }\n}\n\n// So instanceof works\nObject.setPrototypeOf(TrackedMap.prototype, Map.prototype);\n\nexport class TrackedWeakMap<K extends object = object, V = unknown>\n  implements WeakMap<K, V>\n{\n  private storages: WeakMap<K, TrackedStorage<null>> = new WeakMap();\n\n  private vals: WeakMap<K, V>;\n\n  private readStorageFor(key: K): void {\n    const { storages } = this;\n    let storage = storages.get(key);\n\n    if (storage === undefined) {\n      storage = createStorage(null, () => false);\n      storages.set(key, storage);\n    }\n\n    getValue(storage);\n  }\n\n  private dirtyStorageFor(key: K): void {\n    const storage = this.storages.get(key);\n\n    if (storage) {\n      setValue(storage, null);\n    }\n  }\n\n  constructor();\n  constructor(iterable: Iterable<readonly [K, V]>);\n  constructor(entries: readonly [K, V][] | null);\n  constructor(\n    existing?: readonly [K, V][] | Iterable<readonly [K, V]> | null | undefined\n  ) {\n    // TypeScript doesn't correctly resolve the overloads for calling the `Map`\n    // constructor for the no-value constructor. This resolves that.\n    this.vals = existing ? new WeakMap(existing) : new WeakMap();\n  }\n\n  get(key: K): V | undefined {\n    this.readStorageFor(key);\n\n    return this.vals.get(key);\n  }\n\n  has(key: K): boolean {\n    this.readStorageFor(key);\n\n    return this.vals.has(key);\n  }\n\n  set(key: K, value: V): this {\n    this.dirtyStorageFor(key);\n\n    this.vals.set(key, value);\n\n    return this;\n  }\n\n  delete(key: K): boolean {\n    this.dirtyStorageFor(key);\n\n    return this.vals.delete(key);\n  }\n\n  get [Symbol.toStringTag](): string {\n    return this.vals[Symbol.toStringTag];\n  }\n}\n\n// So instanceof works\nObject.setPrototypeOf(TrackedWeakMap.prototype, WeakMap.prototype);\n"],"names":["TrackedMap","collection","createStorage","storages","Map","readStorageFor","key","storage","get","undefined","set","getValue","dirtyStorageFor","setValue","constructor","existing","vals","has","entries","keys","values","forEach","fn","size","Symbol","iterator","toStringTag","value","delete","clear","s","Object","setPrototypeOf","prototype","TrackedWeakMap","WeakMap"],"mappings":"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"}