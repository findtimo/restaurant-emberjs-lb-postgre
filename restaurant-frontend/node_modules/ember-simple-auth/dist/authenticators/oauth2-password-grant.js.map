{"version":3,"file":"oauth2-password-grant.js","sources":["../../src/authenticators/oauth2-password-grant.js"],"sourcesContent":["import RSVP from 'rsvp';\nimport { isEmpty } from '@ember/utils';\nimport { run, later, cancel } from '@ember/runloop';\nimport { A, makeArray } from '@ember/array';\nimport { warn } from '@ember/debug';\nimport { getOwner } from '@ember/application';\nimport BaseAuthenticator from './base';\nimport isFastBoot from '../utils/is-fastboot';\nimport { waitFor } from '@ember/test-waiters';\nimport { isTesting } from '@embroider/macros';\n\n/**\n  Authenticator that conforms to OAuth 2\n  ([RFC 6749](http://tools.ietf.org/html/rfc6749)), specifically the _\"Resource\n  Owner Password Credentials Grant Type\"_.\n\n  This authenticator also automatically refreshes access tokens (see\n  [RFC 6749, section 6](http://tools.ietf.org/html/rfc6749#section-6)) if the\n  server supports it.\n\n  @class OAuth2PasswordGrantAuthenticator\n  @module ember-simple-auth/authenticators/oauth2-password-grant\n  @extends BaseAuthenticator\n  @public\n*/\nexport default BaseAuthenticator.extend({\n  /**\n    Triggered when the authenticator refreshed the access token (see\n    [RFC 6749, section 6](http://tools.ietf.org/html/rfc6749#section-6)).\n\n    @event sessionDataUpdated\n    @param {Object} data The updated session data\n    @public\n  */\n\n  /**\n    The client_id to be sent to the authentication server (see\n    https://tools.ietf.org/html/rfc6749#appendix-A.1). __This should only be\n    used for statistics or logging etc. as it cannot actually be trusted since\n    it could have been manipulated on the client!__\n\n    @property clientId\n    @type String\n    @default null\n    @public\n  */\n  clientId: null,\n\n  /**\n    The endpoint on the server that authentication and token refresh requests\n    are sent to.\n\n    @property serverTokenEndpoint\n    @type String\n    @default '/token'\n    @public\n  */\n  serverTokenEndpoint: '/token',\n\n  /**\n    The endpoint on the server that token revocation requests are sent to. Only\n    set this if the server actually supports token revocation. If this is\n    `null`, the authenticator will not revoke tokens on session invalidation.\n\n    __If token revocation is enabled but fails, session invalidation will be\n    intercepted and the session will remain authenticated (see\n    {{#crossLink \"OAuth2PasswordGrantAuthenticator/invalidate:method\"}}{{/crossLink}}).__\n\n    @property serverTokenRevocationEndpoint\n    @type String\n    @default null\n    @public\n  */\n  serverTokenRevocationEndpoint: null,\n\n  /**\n    Sets whether the authenticator automatically refreshes access tokens if the\n    server supports it.\n\n    @property refreshAccessTokens\n    @type Boolean\n    @default true\n    @public\n  */\n  refreshAccessTokens: true,\n\n  /**\n    The offset time in milliseconds to refresh the access token. This must\n    return a random number. This randomization is needed because in case of\n    multiple tabs, we need to prevent the tabs from sending refresh token\n    request at the same exact moment.\n\n    __When overriding this property, make sure to mark the overridden property\n    as volatile so it will actually have a different value each time it is\n    accessed.__\n\n    @property tokenRefreshOffset\n    @type Integer\n    @default a random number between 5 and 10\n    @public\n  */\n  get tokenRefreshOffset() {\n    const min = 5;\n    const max = 10;\n\n    return (Math.floor(Math.random() * (max - min)) + min) * 1000;\n  },\n\n  _refreshTokenTimeout: null,\n\n  /**\n    Restores the session from a session data object; __will return a resolving\n    promise when there is a non-empty `access_token` in the session data__ and\n    a rejecting promise otherwise.\n\n    If the server issues\n    [expiring access tokens](https://tools.ietf.org/html/rfc6749#section-5.1)\n    and there is an expired access token in the session data along with a\n    refresh token, the authenticator will try to refresh the access token and\n    return a promise that resolves with the new access token if the refresh was\n    successful. If there is no refresh token or the token refresh is not\n    successful, a rejecting promise will be returned.\n\n    @method restore\n    @param {Object} data The data to restore the session from\n    @return {Ember.RSVP.Promise} A promise that when it resolves results in the session becoming or remaining authenticated. If restoration fails, the promise will reject with the server response (in case the access token had expired and was refreshed using a refresh token); however, the authenticator reads that response already so if you need to read it again you need to clone the response object first\n    @public\n  */\n  restore(data) {\n    return new RSVP.Promise((resolve, reject) => {\n      const now = (new Date()).getTime();\n      const refreshAccessTokens = this.get('refreshAccessTokens');\n      if (!isEmpty(data['expires_at']) && data['expires_at'] < now) {\n        if (refreshAccessTokens) {\n          this._refreshAccessToken(data['expires_in'], data['refresh_token']).then(resolve, reject);\n        } else {\n          reject();\n        }\n      } else {\n        if (!this._validate(data)) {\n          reject();\n        } else {\n          this._scheduleAccessTokenRefresh(data['expires_in'], data['expires_at'], data['refresh_token']);\n          resolve(data);\n        }\n      }\n    });\n  },\n\n  /**\n    Authenticates the session with the specified `identification`, `password`\n    and optional `scope`; issues a `POST` request to the\n    {{#crossLink \"OAuth2PasswordGrantAuthenticator/serverTokenEndpoint:property\"}}{{/crossLink}}\n    and receives the access token in response (see\n    http://tools.ietf.org/html/rfc6749#section-4.3).\n\n    __If the credentials are valid (and the optionally requested scope is\n    granted) and thus authentication succeeds, a promise that resolves with the\n    server's response is returned__, otherwise a promise that rejects with the\n    error as returned by the server is returned.\n\n    __If the\n    [server supports it](https://tools.ietf.org/html/rfc6749#section-5.1), this\n    method also schedules refresh requests for the access token before it\n    expires.__\n\n    The server responses are expected to look as defined in the spec (see\n    http://tools.ietf.org/html/rfc6749#section-5). The response to a successful\n    authentication request should be:\n\n    ```json\n    HTTP/1.1 200 OK\n    Content-Type: application/json;charset=UTF-8\n\n    {\n      \"access_token\":\"2YotnFZFEjr1zCsicMWpAA\",\n      \"token_type\":\"bearer\",\n      \"expires_in\":3600, // optional\n      \"refresh_token\":\"tGzv3JOkF0XG5Qx2TlKWIA\" // optional\n    }\n    ```\n\n    The response for a failing authentication request should be:\n\n    ```json\n    HTTP/1.1 400 Bad Request\n    Content-Type: application/json;charset=UTF-8\n\n    {\n      \"error\":\"invalid_grant\"\n    }\n    ```\n\n    A full list of error codes can be found\n    [here](https://tools.ietf.org/html/rfc6749#section-5.2).\n\n    @method authenticate\n    @param {String} identification The resource owner username\n    @param {String} password The resource owner password\n    @param {String|Array} scope The scope of the access request (see [RFC 6749, section 3.3](http://tools.ietf.org/html/rfc6749#section-3.3))\n    @param {Object} headers Optional headers that particular backends may require (for example sending 2FA challenge responses)\n    @return {Ember.RSVP.Promise} A promise that when it resolves results in the session becoming authenticated. If authentication fails, the promise will reject with the server response; however, the authenticator reads that response already so if you need to read it again you need to clone the response object first\n    @public\n  */\n  authenticate(identification, password, scope = [], headers = {}) {\n    return new RSVP.Promise((resolve, reject) => {\n      const data = { 'grant_type': 'password', username: identification, password };\n      const serverTokenEndpoint = this.get('serverTokenEndpoint');\n\n      const scopesString = makeArray(scope).join(' ');\n      if (!isEmpty(scopesString)) {\n        data.scope = scopesString;\n      }\n      this.makeRequest(serverTokenEndpoint, data, headers).then((response) => {\n        run(() => {\n          if (!this._validate(response)) {\n            reject('access_token is missing in server response');\n          }\n\n          const expiresAt = this._absolutizeExpirationTime(response['expires_in']);\n          this._scheduleAccessTokenRefresh(response['expires_in'], expiresAt, response['refresh_token']);\n          if (!isEmpty(expiresAt)) {\n            response = Object.assign(response, { 'expires_at': expiresAt });\n          }\n\n          resolve(response);\n        });\n      }, (response) => {\n        run(null, reject, response);\n      });\n    });\n  },\n\n  /**\n    If token revocation is enabled, this will revoke the access token (and the\n    refresh token if present). If token revocation succeeds, this method\n    returns a resolving promise, otherwise it will return a rejecting promise,\n    thus intercepting session invalidation.\n\n    If token revocation is not enabled this method simply returns a resolving\n    promise.\n\n    @method invalidate\n    @param {Object} data The current authenticated session data\n    @return {Ember.RSVP.Promise} A promise that when it resolves results in the session being invalidated. If invalidation fails, the promise will reject with the server response (in case token revocation is used); however, the authenticator reads that response already so if you need to read it again you need to clone the response object first\n    @public\n  */\n  invalidate(data) {\n    const serverTokenRevocationEndpoint = this.get('serverTokenRevocationEndpoint');\n    function success(resolve) {\n      cancel(this._refreshTokenTimeout);\n      delete this._refreshTokenTimeout;\n      resolve();\n    }\n    return new RSVP.Promise((resolve) => {\n      if (isEmpty(serverTokenRevocationEndpoint)) {\n        success.apply(this, [resolve]);\n      } else {\n        const requests = [];\n        A(['access_token', 'refresh_token']).forEach((tokenType) => {\n          const token = data[tokenType];\n          if (!isEmpty(token)) {\n            requests.push(this.makeRequest(serverTokenRevocationEndpoint, {\n              'token_type_hint': tokenType, token\n            }));\n          }\n        });\n        const succeed = () => {\n          success.apply(this, [resolve]);\n        };\n        RSVP.all(requests).then(succeed, succeed);\n      }\n    });\n  },\n\n  /**\n    Makes a request to the OAuth 2.0 server.\n\n    @method makeRequest\n    @param {String} url The request URL\n    @param {Object} data The request data\n    @param {Object} headers Additional headers to send in request\n    @return {Promise} A promise that resolves with the response object\n    @protected\n  */\n  makeRequest: waitFor(function(url, data, headers = {}) {\n    headers['Content-Type'] = 'application/x-www-form-urlencoded';\n\n    const clientId = this.get('clientId');\n    if (!isEmpty(clientId)) {\n      data['client_id'] = this.get('clientId');\n    }\n\n    const body = Object.keys(data).map((key) => {\n      return `${encodeURIComponent(key)}=${encodeURIComponent(data[key])}`;\n    }).join('&');\n\n    const options = {\n      body,\n      headers,\n      method: 'POST'\n    };\n\n    return new RSVP.Promise((resolve, reject) => {\n      fetch(url, options).then((response) => {\n        response.text().then((text) => {\n          try {\n            let json = JSON.parse(text);\n            if (!response.ok) {\n              response.responseJSON = json;\n              reject(response);\n            } else {\n              resolve(json);\n            }\n          } catch (SyntaxError) {\n            response.responseText = text;\n            reject(response);\n          }\n        });\n      }).catch(reject);\n    });\n  }),\n\n  _scheduleAccessTokenRefresh(expiresIn, expiresAt, refreshToken) {\n    const refreshAccessTokens = this.get('refreshAccessTokens') && !isFastBoot(getOwner(this));\n    if (refreshAccessTokens) {\n      const now = (new Date()).getTime();\n      if (isEmpty(expiresAt) && !isEmpty(expiresIn)) {\n        expiresAt = new Date(now + expiresIn * 1000).getTime();\n      }\n      const offset = this.get('tokenRefreshOffset');\n      if (!isEmpty(refreshToken) && !isEmpty(expiresAt) && expiresAt > now - offset) {\n        cancel(this._refreshTokenTimeout);\n        delete this._refreshTokenTimeout;\n        if (!isTesting()) {\n          this._refreshTokenTimeout = later(this, this._refreshAccessToken, expiresIn, refreshToken, expiresAt - now - offset);\n        }\n      }\n    }\n  },\n\n  _refreshAccessToken(expiresIn, refreshToken) {\n    const data = { 'grant_type': 'refresh_token', 'refresh_token': refreshToken };\n    const serverTokenEndpoint = this.get('serverTokenEndpoint');\n    return new RSVP.Promise((resolve, reject) => {\n      this.makeRequest(serverTokenEndpoint, data).then((response) => {\n        run(() => {\n          expiresIn = response['expires_in'] || expiresIn;\n          refreshToken = response['refresh_token'] || refreshToken;\n          const expiresAt = this._absolutizeExpirationTime(expiresIn);\n          const data = Object.assign(response, { 'expires_in': expiresIn, 'expires_at': expiresAt, 'refresh_token': refreshToken });\n          this._scheduleAccessTokenRefresh(expiresIn, null, refreshToken);\n          this.trigger('sessionDataUpdated', data);\n          resolve(data);\n        });\n      }, (response) => {\n        warn(`Access token could not be refreshed - server responded with ${response.responseJSON}.`, false, { id: 'ember-simple-auth.failedOAuth2TokenRefresh' });\n        reject();\n      });\n    });\n  },\n\n  _absolutizeExpirationTime(expiresIn) {\n    if (!isEmpty(expiresIn)) {\n      return new Date((new Date().getTime()) + expiresIn * 1000).getTime();\n    }\n  },\n\n  _validate(data) {\n    return !isEmpty(data['access_token']);\n  }\n});\n"],"names":["BaseAuthenticator","extend","clientId","serverTokenEndpoint","serverTokenRevocationEndpoint","refreshAccessTokens","tokenRefreshOffset","min","max","Math","floor","random","_refreshTokenTimeout","restore","data","RSVP","Promise","resolve","reject","now","Date","getTime","get","isEmpty","_refreshAccessToken","then","_validate","_scheduleAccessTokenRefresh","authenticate","identification","password","scope","headers","username","scopesString","makeArray","join","makeRequest","response","run","expiresAt","_absolutizeExpirationTime","Object","assign","invalidate","success","cancel","apply","requests","A","forEach","tokenType","token","push","succeed","all","waitFor","url","body","keys","map","key","encodeURIComponent","options","method","fetch","text","json","JSON","parse","ok","responseJSON","SyntaxError","responseText","catch","expiresIn","refreshToken","isFastBoot","getOwner","offset","isTesting","later","trigger","warn","id"],"mappings":"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"}