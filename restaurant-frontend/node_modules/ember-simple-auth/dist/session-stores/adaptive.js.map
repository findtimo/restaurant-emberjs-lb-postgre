{"version":3,"file":"adaptive.js","sources":["../../src/session-stores/adaptive.js"],"sourcesContent":["import { computed } from '@ember/object';\nimport { inject as service } from '@ember/service';\nimport { getOwner } from '@ember/application';\nimport Base from './base';\n\nconst LOCAL_STORAGE_TEST_KEY = '_ember_simple_auth_test_key';\n\nconst proxyToInternalStore = function() {\n  return computed({\n    get(key) {\n      return this.get(`_${key}`);\n    },\n    set(key, value) {\n      this.set(`_${key}`, value);\n      let _store = this.get('_store');\n      if (_store) {\n        _store.set(key, value);\n      }\n      return value;\n    }\n  });\n};\n\n/**\n  Session store that persists data in the browser's `localStorage` (see\n  {{#crossLink \"LocalStorageStore\"}}{{/crossLink}}) if that is available or in\n  a cookie (see {{#crossLink \"CookieStore\"}}{{/crossLink}}) if it is not.\n\n  __This is the default store that Ember Simple Auth will use when the\n  application doesn't define a custom store.__\n\n  __This session store does not work with FastBoot. In order to use Ember\n  Simple Auth with FastBoot, configure the\n  {{#crossLink \"CookieStore\"}}{{/crossLink}} as the application's session\n  store.__\n\n  @class AdaptiveStore\n  @module ember-simple-auth/session-stores/adaptive\n  @extends BaseStore\n  @public\n*/\nexport default Base.extend({\n  /**\n    The `localStorage` key the store persists data in if `localStorage` is\n    available.\n\n    @property localStorageKey\n    @type String\n    @default 'ember_simple_auth-session'\n    @public\n  */\n  localStorageKey: 'ember_simple_auth-session',\n\n  /**\n    The domain to use for the cookie if `localStorage` is not available, e.g.,\n    \"example.com\", \".example.com\" (which includes all subdomains) or\n    \"subdomain.example.com\". If not explicitly set, the cookie domain defaults\n    to the domain the session was authenticated on.\n\n    @property cookieDomain\n    @type String\n    @default null\n    @public\n  */\n  _cookieDomain: null,\n  cookieDomain: proxyToInternalStore(),\n\n  /**\n    Allows servers to assert that a cookie ought not to be sent along with\n    cross-site requests, which provides some protection against cross-site\n    request forgery attacks (CSRF).\n\n    Available options:\n    - \"Strict\"\n    - \"Lax\"\n\n    @property sameSite\n    @type String\n    @default null\n    @public\n  */\n  _sameSite: null,\n  sameSite: proxyToInternalStore(),\n\n  /**\n    The name of the cookie to use if `localStorage` is not available.\n\n    @property cookieName\n    @type String\n    @default ember_simple_auth-session\n    @public\n  */\n  _cookieName: 'ember_simple_auth-session',\n  cookieName: proxyToInternalStore(),\n\n  /**\n    The path to use for the cookie, e.g., \"/\", \"/something\".\n\n    @property cookiePath\n    @type String\n    @default '/'\n    @public\n  */\n  _cookiePath: '/',\n  cookiePath: proxyToInternalStore(),\n\n  /**\n    The expiration time for the cookie in seconds if `localStorage` is not\n    available. A value of `null` will make the cookie a session cookie that\n    expires and gets deleted when the browser is closed.\n\n    @property cookieExpirationTime\n    @default null\n    @type Integer\n    @public\n  */\n  _cookieExpirationTime: null,\n  cookieExpirationTime: proxyToInternalStore(),\n\n  _cookies: service('cookies'),\n\n  _isLocalStorageAvailable: computed({\n    get() {\n      return testLocalStorageAvailable();\n    },\n\n    set(key, value) {\n      return value;\n    }\n  }),\n\n  init() {\n    this._super(...arguments);\n\n    let owner = getOwner(this);\n    if (owner && !this.hasOwnProperty('_fastboot')) {\n      this._fastboot = owner.lookup('service:fastboot');\n    }\n\n    let store;\n    if (this.get('_isLocalStorageAvailable')) {\n      const localStorage = owner.lookup('session-store:local-storage');\n      const options = { key: this.get('localStorageKey') };\n\n      options._isFastBoot = false;\n      localStorage.setProperties(options);\n\n      store = localStorage;\n    } else {\n      const cookieStorage = owner.lookup('session-store:cookie');\n      const options = this.getProperties('cookieDomain', 'cookieName', 'cookieExpirationTime', 'cookiePath', 'sameSite');\n\n      cookieStorage.setProperties(options);\n      this.set('cookieExpirationTime', cookieStorage.get('cookieExpirationTime'));\n\n      store = cookieStorage;\n    }\n\n    this.set('_store', store);\n    this._setupStoreEvents(store);\n  },\n\n  _setupStoreEvents(store) {\n    store.on('sessionDataUpdated', (data) => {\n      this.trigger('sessionDataUpdated', data);\n    });\n    return store;\n  },\n\n  /**\n    Persists the `data` in the `localStorage` if it is available or in a cookie\n    if it is not.\n\n    @method persist\n    @param {Object} data The data to persist\n    @return {Ember.RSVP.Promise} A promise that resolves when the data has successfully been persisted and rejects otherwise.\n    @public\n  */\n  persist() {\n    return this.get('_store').persist(...arguments);\n  },\n\n  /**\n    Returns all data currently stored in the `localStorage` if that is\n    available - or if it is not, in the cookie - as a plain object.\n\n    @method restore\n    @return {Ember.RSVP.Promise} A promise that resolves with the data currently persisted in the store when the data has been restored successfully and rejects otherwise.\n    @public\n  */\n  restore() {\n    return this.get('_store').restore();\n  },\n\n  /**\n    Clears the store by deleting the\n    {{#crossLink \"LocalStorageStore/key:property\"}}{{/crossLink}} from\n    `localStorage` if that is available or by deleting the cookie if it is not.\n\n    @method clear\n    @return {Ember.RSVP.Promise} A promise that resolves when the store has been cleared successfully and rejects otherwise.\n    @public\n  */\n  clear() {\n    return this.get('_store').clear();\n  }\n});\n\nfunction testLocalStorageAvailable() {\n  try {\n    localStorage.setItem(LOCAL_STORAGE_TEST_KEY, true);\n    localStorage.removeItem(LOCAL_STORAGE_TEST_KEY);\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n"],"names":["LOCAL_STORAGE_TEST_KEY","proxyToInternalStore","computed","get","key","set","value","_store","Base","extend","localStorageKey","_cookieDomain","cookieDomain","_sameSite","sameSite","_cookieName","cookieName","_cookiePath","cookiePath","_cookieExpirationTime","cookieExpirationTime","_cookies","service","_isLocalStorageAvailable","testLocalStorageAvailable","init","_super","arguments","owner","getOwner","hasOwnProperty","_fastboot","lookup","store","localStorage","options","_isFastBoot","setProperties","cookieStorage","getProperties","_setupStoreEvents","on","data","trigger","persist","restore","clear","setItem","removeItem","e"],"mappings":"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"}